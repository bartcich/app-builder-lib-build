{"version":3,"sources":["../../src/asar/asar.ts"],"names":[],"mappings":"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","sourcesContent":["import { createFromBuffer } from \"chromium-pickle-js\"\r\nimport { close, open, read, readFile, Stats } from \"fs-extra-p\"\r\nimport * as path from \"path\"\r\n\r\n/** @internal */\r\nexport class Node {\r\n  // we don't use Map because later it will be stringified\r\n  files?: { [key: string]: Node }\r\n\r\n  unpacked?: boolean\r\n\r\n  size?: number\r\n  // electron expects string\r\n  offset?: string\r\n\r\n  executable?: boolean\r\n\r\n  link?: string\r\n}\r\n\r\n/** @internal */\r\nexport class AsarFilesystem {\r\n  private offset = 0\r\n\r\n  constructor(readonly src: string, readonly header = new Node(), readonly headerSize: number = -1) {\r\n    if (this.header.files == null) {\r\n      this.header.files = {}\r\n    }\r\n  }\r\n\r\n  searchNodeFromDirectory(p: string, isCreate: boolean): Node | null {\r\n    let node = this.header\r\n    for (const dir of p.split(path.sep)) {\r\n      if (dir !== \".\") {\r\n        let child = node.files![dir]\r\n        if (child == null) {\r\n          if (!isCreate) {\r\n            return null\r\n          }\r\n          child = new Node()\r\n          child.files = {}\r\n          node.files![dir] = child\r\n        }\r\n        node = child\r\n      }\r\n    }\r\n    return node\r\n  }\r\n\r\n  getOrCreateNode(p: string): Node {\r\n    if (p == null || p.length === 0) {\r\n      return this.header\r\n    }\r\n\r\n    const name = path.basename(p)\r\n    const dirNode = this.searchNodeFromDirectory(path.dirname(p), true)!\r\n    if (dirNode.files == null) {\r\n      dirNode.files = {}\r\n    }\r\n\r\n    let result = dirNode.files[name]\r\n    if (result == null) {\r\n      result = new Node()\r\n      dirNode.files[name] = result\r\n    }\r\n    return result\r\n  }\r\n\r\n  addFileNode(file: string, dirNode: Node, size: number, unpacked: boolean, stat: Stats): Node {\r\n    if (size > 4294967295) {\r\n      throw new Error(`${file}: file size cannot be larger than 4.2GB`)\r\n    }\r\n\r\n    const node = new Node()\r\n    node.size = size\r\n    if (unpacked) {\r\n      node.unpacked = true\r\n    }\r\n    else {\r\n      // electron expects string\r\n      node.offset = this.offset.toString()\r\n      if (process.platform !== \"win32\" && (stat.mode & 0o100)) {\r\n        node.executable = true\r\n      }\r\n      this.offset += node.size\r\n    }\r\n\r\n    let children = dirNode.files\r\n    if (children == null) {\r\n      children = {}\r\n      dirNode.files = children\r\n    }\r\n    children[path.basename(file)] = node\r\n\r\n    return node\r\n  }\r\n\r\n  getNode(p: string) {\r\n    const node = this.searchNodeFromDirectory(path.dirname(p), false)!\r\n    return node.files![path.basename(p)]\r\n  }\r\n\r\n  getFile(p: string, followLinks: boolean = true): Node {\r\n    const info = this.getNode(p)!\r\n    // if followLinks is false we don't resolve symlinks\r\n    return followLinks && info.link != null ? this.getFile(info.link) : info\r\n  }\r\n\r\n  async readJson(file: string): Promise<any> {\r\n    return JSON.parse((await this.readFile(file)).toString())\r\n  }\r\n\r\n  async readFile(file: string): Promise<Buffer> {\r\n    return await readFileFromAsar(this, file, this.getFile(file))\r\n  }\r\n}\r\n\r\nexport async function readAsar(archive: string): Promise<AsarFilesystem> {\r\n  const fd = await open(archive, \"r\")\r\n  let size\r\n  let headerBuf\r\n  try {\r\n    const sizeBuf = Buffer.allocUnsafe(8)\r\n    if (await read(fd, sizeBuf, 0, 8, null as any) !== 8) {\r\n      throw new Error(\"Unable to read header size\")\r\n    }\r\n\r\n    const sizePickle = createFromBuffer(sizeBuf)\r\n    size = sizePickle.createIterator().readUInt32()\r\n    headerBuf = Buffer.allocUnsafe(size)\r\n    if (await read(fd, headerBuf, 0, size, null as any) !== size) {\r\n      throw new Error(\"Unable to read header\")\r\n    }\r\n  }\r\n  finally {\r\n    await close(fd)\r\n  }\r\n\r\n  const headerPickle = createFromBuffer(headerBuf!)\r\n  const header = headerPickle.createIterator().readString()\r\n  return new AsarFilesystem(archive, JSON.parse(header), size)\r\n}\r\n\r\nexport async function readAsarJson(archive: string, file: string): Promise<any> {\r\n  const fs = await readAsar(archive)\r\n  return await fs.readJson(file)\r\n}\r\n\r\nasync function readFileFromAsar(filesystem: AsarFilesystem, filename: string, info: Node): Promise<Buffer> {\r\n  const size = info.size!!\r\n  const buffer = Buffer.allocUnsafe(size)\r\n  if (size <= 0) {\r\n    return buffer\r\n  }\r\n\r\n  if (info.unpacked) {\r\n    return await readFile(path.join(`${filesystem.src}.unpacked`, filename))\r\n  }\r\n\r\n  const fd = await open(filesystem.src, \"r\")\r\n  try {\r\n    const offset = 8 + filesystem.headerSize + parseInt(info.offset!!, 10)\r\n    await read(fd, buffer, 0, size, offset)\r\n  }\r\n  finally {\r\n    await close(fd)\r\n  }\r\n  return buffer\r\n}\r\n"],"sourceRoot":""}
