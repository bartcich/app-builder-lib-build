{"version":3,"sources":["../../src/codeSign/windowsCodeSign.ts"],"names":[],"mappings":"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","sourcesContent":["import { InvalidConfigurationError, asArray, log } from \"builder-util/out/util\"\r\nimport { getBin } from \"../binDownload\"\r\nimport { executeAppBuilderAsJson } from \"../util/appBuilder\"\r\nimport { computeToolEnv, ToolInfo } from \"../util/bundledTool\"\r\nimport { rename } from \"fs-extra-p\"\r\nimport * as os from \"os\"\r\nimport * as path from \"path\"\r\nimport { WindowsConfiguration } from \"..\"\r\nimport { resolveFunction } from \"../platformPackager\"\r\nimport { isUseSystemSigncode } from \"../util/flags\"\r\nimport { VmManager } from \"../vm/vm\"\r\nimport { WinPackager } from \"../winPackager\"\r\n\r\nexport function getSignVendorPath() {\r\n  return getBin(\"winCodeSign\")\r\n}\r\n\r\nexport type CustomWindowsSign = (configuration: CustomWindowsSignTaskConfiguration) => Promise<any>\r\n\r\nexport interface WindowsSignOptions {\r\n  readonly path: string\r\n\r\n  readonly name?: string | null\r\n  readonly cscInfo?: FileCodeSigningInfo | CertificateFromStoreInfo | null\r\n  readonly site?: string | null\r\n\r\n  readonly options: WindowsConfiguration\r\n}\r\n\r\nexport interface WindowsSignTaskConfiguration extends WindowsSignOptions {\r\n  // set if output path differs from input (e.g. osslsigncode cannot sign file inplace)\r\n  resultOutputPath?: string\r\n\r\n  hash: string\r\n  isNest: boolean\r\n}\r\n\r\nexport interface CustomWindowsSignTaskConfiguration extends WindowsSignTaskConfiguration {\r\n  computeSignToolArgs(isWin: boolean): Array<string>\r\n}\r\n\r\nexport async function sign(options: WindowsSignOptions, packager: WinPackager) {\r\n  let hashes = options.options.signingHashAlgorithms\r\n  // msi does not support dual-signing\r\n  if (options.path.endsWith(\".msi\")) {\r\n    hashes = [hashes != null && !hashes.includes(\"sha1\") ? \"sha256\" : \"sha1\"]\r\n  }\r\n  else if (options.path.endsWith(\".appx\")) {\r\n    hashes = [\"sha256\"]\r\n  }\r\n  else if (hashes == null) {\r\n    hashes = [\"sha1\", \"sha256\"]\r\n  }\r\n  else {\r\n    hashes = Array.isArray(hashes) ? hashes : [hashes]\r\n  }\r\n\r\n  function defaultExecutor(configuration: CustomWindowsSignTaskConfiguration) {\r\n    return doSign(configuration, packager)\r\n  }\r\n\r\n  const executor = resolveFunction(options.options.sign, \"sign\") || defaultExecutor\r\n  let isNest = false\r\n  for (const hash of hashes) {\r\n    const taskConfiguration: WindowsSignTaskConfiguration = {...options, hash, isNest}\r\n    await executor({\r\n      ...taskConfiguration,\r\n      computeSignToolArgs: isWin => computeSignToolArgs(taskConfiguration, isWin)\r\n    })\r\n    isNest = true\r\n    if (taskConfiguration.resultOutputPath != null) {\r\n      await rename(taskConfiguration.resultOutputPath, options.path)\r\n    }\r\n  }\r\n}\r\n\r\nexport interface FileCodeSigningInfo {\r\n  readonly file: string\r\n  readonly password: string | null\r\n}\r\n\r\nexport async function getCertInfo(file: string, password: string): Promise<CertificateInfo> {\r\n  let result: any = null\r\n  try {\r\n    result = await executeAppBuilderAsJson<any>([\"certificate-info\", \"--input\", file, \"--password\", password])\r\n  }\r\n  catch (e) {\r\n    throw new Error(`Cannot extract publisher name from code signing certificate, please file issue. As workaround, set win.publisherName: ${e.stack || e}`)\r\n  }\r\n\r\n  if (result.error != null) {\r\n    // noinspection ExceptionCaughtLocallyJS\r\n    throw new InvalidConfigurationError(`Cannot extract publisher name from code signing certificate: ${result.error}`)\r\n  }\r\n  return result\r\n}\r\n\r\nexport interface CertificateInfo {\r\n  readonly commonName: string\r\n  readonly bloodyMicrosoftSubjectDn: string\r\n}\r\n\r\nexport interface CertificateFromStoreInfo {\r\n  thumbprint: string\r\n  subject: string\r\n  store: string\r\n  isLocalMachineStore: boolean\r\n}\r\n\r\nexport async function getCertificateFromStoreInfo(options: WindowsConfiguration, vm: VmManager): Promise<CertificateFromStoreInfo> {\r\n  const certificateSubjectName = options.certificateSubjectName\r\n  const certificateSha1 = options.certificateSha1\r\n  // ExcludeProperty doesn't work, so, we cannot exclude RawData, it is ok\r\n  // powershell can return object if the only item\r\n  const rawResult = await vm.exec(\"powershell.exe\", [\"Get-ChildItem -Recurse Cert: -CodeSigningCert | Select-Object -Property Subject,PSParentPath,Thumbprint | ConvertTo-Json -Compress\"])\r\n  const certList = rawResult.length === 0 ? [] : asArray<CertInfo>(JSON.parse(rawResult))\r\n  for (const certInfo of certList) {\r\n    if (certificateSubjectName != null) {\r\n      if (!certInfo.Subject.includes(certificateSubjectName)) {\r\n        continue\r\n      }\r\n    }\r\n    else if (certInfo.Thumbprint !== certificateSha1) {\r\n      continue\r\n    }\r\n\r\n    const parentPath = certInfo.PSParentPath\r\n    const store = parentPath.substring(parentPath.lastIndexOf(\"\\\\\") + 1)\r\n    log.debug({store, PSParentPath: parentPath}, \"auto-detect certificate store\")\r\n    // https://github.com/electron-userland/electron-builder/issues/1717\r\n    const isLocalMachineStore = (parentPath.includes(\"Certificate::LocalMachine\"))\r\n    log.debug(null, \"auto-detect using of LocalMachine store\")\r\n    return {\r\n      thumbprint: certInfo.Thumbprint,\r\n      subject: certInfo.Subject,\r\n      store,\r\n      isLocalMachineStore\r\n    }\r\n  }\r\n\r\n  throw new Error(`Cannot find certificate ${certificateSubjectName || certificateSha1}, all certs: ${rawResult}`)\r\n}\r\n\r\nasync function doSign(configuration: CustomWindowsSignTaskConfiguration, packager: WinPackager) {\r\n  // https://github.com/electron-userland/electron-builder/pull/1944\r\n  const timeout = parseInt(process.env.SIGNTOOL_TIMEOUT as any, 10) || 10 * 60 * 1000\r\n\r\n  let tool: string\r\n  let args: Array<string>\r\n  let env = process.env\r\n  let vm: VmManager\r\n  if (configuration.path.endsWith(\".appx\") || !(\"file\" in configuration.cscInfo!!) /* certificateSubjectName and other such options */) {\r\n    vm = await packager.vm.value\r\n    tool = getWinSignTool(await getSignVendorPath())\r\n    args = computeSignToolArgs(configuration, true, vm)\r\n  }\r\n  else {\r\n    vm = new VmManager()\r\n    const toolInfo = await getToolPath()\r\n    tool = toolInfo.path\r\n    args = configuration.computeSignToolArgs(process.platform === \"win32\")\r\n    if (toolInfo.env != null) {\r\n      env = toolInfo.env\r\n    }\r\n  }\r\n\r\n  try {\r\n    await vm.exec(tool, args, {timeout, env})\r\n  }\r\n  catch (e) {\r\n    if (e.message.includes(\"The file is being used by another process\") || e.message.includes(\"The specified timestamp server either could not be reached\")) {\r\n      log.warn(`First attempt to code sign failed, another attempt will be made in 2 seconds: ${e.message}`)\r\n      await new Promise((resolve, reject) => {\r\n        setTimeout(() => {\r\n          vm.exec(tool, args, {timeout, env})\r\n            .then(resolve)\r\n            .catch(reject)\r\n        }, 2000)\r\n      })\r\n    }\r\n    throw e\r\n  }\r\n}\r\n\r\ninterface CertInfo {\r\n  Subject: string\r\n  Thumbprint: string\r\n  PSParentPath: string\r\n}\r\n\r\n// on windows be aware of http://stackoverflow.com/a/32640183/1910191\r\nfunction computeSignToolArgs(options: WindowsSignTaskConfiguration, isWin: boolean, vm: VmManager = new VmManager()): Array<string> {\r\n  const inputFile = vm.toVmFile(options.path)\r\n  const outputPath = isWin ? inputFile : getOutputPath(inputFile, options.hash)\r\n  if (!isWin) {\r\n    options.resultOutputPath = outputPath\r\n  }\r\n\r\n  const args = isWin ? [\"sign\"] : [\"-in\", inputFile, \"-out\", outputPath]\r\n\r\n  if (process.env.ELECTRON_BUILDER_OFFLINE !== \"true\") {\r\n    const timestampingServiceUrl = options.options.timeStampServer || \"http://timestamp.verisign.com/scripts/timstamp.dll\"\r\n    if (isWin) {\r\n      args.push(options.isNest || options.hash === \"sha256\" ? \"/tr\" : \"/t\", options.isNest || options.hash === \"sha256\" ? (options.options.rfc3161TimeStampServer || \"http://timestamp.comodoca.com/rfc3161\") : timestampingServiceUrl)\r\n    }\r\n    else {\r\n      args.push(\"-t\", timestampingServiceUrl)\r\n    }\r\n  }\r\n\r\n  const certificateFile = (options.cscInfo as FileCodeSigningInfo).file\r\n  if (certificateFile == null) {\r\n    const cscInfo = (options.cscInfo as CertificateFromStoreInfo)\r\n    const subjectName = cscInfo.thumbprint\r\n    if (!isWin) {\r\n      throw new Error(`${subjectName == null ? \"certificateSha1\" : \"certificateSubjectName\"} supported only on Windows`)\r\n    }\r\n\r\n    args.push(\"/sha1\", cscInfo.thumbprint)\r\n    args.push(\"/s\", cscInfo.store)\r\n    if (cscInfo.isLocalMachineStore) {\r\n      args.push(\"/sm\")\r\n    }\r\n  }\r\n  else {\r\n    const certExtension = path.extname(certificateFile)\r\n    if (certExtension === \".p12\" || certExtension === \".pfx\") {\r\n      args.push(isWin ? \"/f\" : \"-pkcs12\", vm.toVmFile(certificateFile))\r\n    }\r\n    else {\r\n      throw new Error(`Please specify pkcs12 (.p12/.pfx) file, ${certificateFile} is not correct`)\r\n    }\r\n  }\r\n\r\n  if (!isWin || options.hash !== \"sha1\") {\r\n    args.push(isWin ? \"/fd\" : \"-h\", options.hash)\r\n    if (isWin && process.env.ELECTRON_BUILDER_OFFLINE !== \"true\") {\r\n      args.push(\"/td\", \"sha256\")\r\n    }\r\n  }\r\n\r\n  if (options.name) {\r\n    args.push(isWin ? \"/d\" : \"-n\", options.name)\r\n  }\r\n\r\n  if (options.site) {\r\n    args.push(isWin ? \"/du\" : \"-i\", options.site)\r\n  }\r\n\r\n  // msi does not support dual-signing\r\n  if (options.isNest) {\r\n    args.push(isWin ? \"/as\" : \"-nest\")\r\n  }\r\n\r\n  const password = options.cscInfo == null ? null : (options.cscInfo as FileCodeSigningInfo).password\r\n  if (password) {\r\n    args.push(isWin ? \"/p\" : \"-pass\", password)\r\n  }\r\n\r\n  if (options.options.additionalCertificateFile) {\r\n    args.push(isWin ? \"/ac\" : \"-ac\", vm.toVmFile(options.options.additionalCertificateFile))\r\n  }\r\n\r\n  const httpsProxyFromEnv = process.env.HTTPS_PROXY\r\n  if (!isWin && httpsProxyFromEnv != null && httpsProxyFromEnv.length) {\r\n    args.push(\"-p\", httpsProxyFromEnv)\r\n  }\r\n\r\n  if (isWin) {\r\n    // https://github.com/electron-userland/electron-builder/issues/2875#issuecomment-387233610\r\n    args.push(\"/debug\")\r\n    // must be last argument\r\n    args.push(inputFile)\r\n  }\r\n\r\n  return args\r\n}\r\n\r\nfunction getOutputPath(inputPath: string, hash: string) {\r\n  const extension = path.extname(inputPath)\r\n  return path.join(path.dirname(inputPath), `${path.basename(inputPath, extension)}-signed-${hash}${extension}`)\r\n}\r\n\r\n/** @internal */\r\nexport function isOldWin6() {\r\n  const winVersion = os.release()\r\n  return winVersion.startsWith(\"6.\") && !winVersion.startsWith(\"6.3\")\r\n}\r\n\r\nfunction getWinSignTool(vendorPath: string): string {\r\n  // use modern signtool on Windows Server 2012 R2 to be able to sign AppX\r\n  if (isOldWin6()) {\r\n    return path.join(vendorPath, \"windows-6\", \"signtool.exe\")\r\n  }\r\n  else {\r\n    return path.join(vendorPath, \"windows-10\", process.arch, \"signtool.exe\")\r\n  }\r\n}\r\n\r\nasync function getToolPath(): Promise<ToolInfo> {\r\n  if (isUseSystemSigncode()) {\r\n    return {path: \"osslsigncode\"}\r\n  }\r\n\r\n  const result = process.env.SIGNTOOL_PATH\r\n  if (result) {\r\n    return {path: result}\r\n  }\r\n\r\n  const vendorPath = await getSignVendorPath()\r\n  if (process.platform === \"win32\") {\r\n    // use modern signtool on Windows Server 2012 R2 to be able to sign AppX\r\n    return {path: getWinSignTool(vendorPath)}\r\n  }\r\n  else if (process.platform === \"darwin\") {\r\n    const toolDirPath = path.join(vendorPath, process.platform, \"10.12\")\r\n    return {\r\n      path: path.join(toolDirPath, \"osslsigncode\"),\r\n      env: computeToolEnv([path.join(toolDirPath, \"lib\")]),\r\n    }\r\n  }\r\n  else {\r\n    return {path: path.join(vendorPath, process.platform, \"osslsigncode\")}\r\n  }\r\n}\r\n"],"sourceRoot":""}
