{"version":3,"sources":["../src/index.ts"],"names":[],"mappings":"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","sourcesContent":["import { executeFinally } from \"builder-util/out/promise\"\r\nimport { PublishOptions } from \"electron-publish/out/publisher\"\r\nimport { log, InvalidConfigurationError } from \"builder-util\"\r\nimport { asArray } from \"builder-util-runtime\"\r\nimport { Packager } from \"./packager\"\r\nimport { PackagerOptions } from \"./packagerApi\"\r\nimport { resolveFunction } from \"./platformPackager\"\r\nimport { PublishManager } from \"./publish/PublishManager\"\r\n\r\nexport { Packager, BuildResult } from \"./packager\"\r\nexport { PackagerOptions, ArtifactCreated, ArtifactBuildStarted } from \"./packagerApi\"\r\nexport { TargetConfiguration, Platform, Target, DIR_TARGET, BeforeBuildContext, SourceRepositoryInfo, TargetSpecificOptions, TargetConfigType, DEFAULT_TARGET, CompressionLevel } from \"./core\"\r\nexport { getArchSuffix, Arch, archFromString } from \"builder-util\"\r\nexport { Configuration, AfterPackContext, MetadataDirectories } from \"./configuration\"\r\nexport { ElectronDownloadOptions, ElectronPlatformName } from \"./electron/ElectronFramework\"\r\nexport { PlatformSpecificBuildOptions, AsarOptions, FileSet, Protocol, ReleaseInfo } from \"./options/PlatformSpecificBuildOptions\"\r\nexport { FileAssociation } from \"./options/FileAssociation\"\r\nexport { MacConfiguration, DmgOptions, MasConfiguration, MacOsTargetName, DmgContent, DmgWindow } from \"./options/macOptions\"\r\nexport { PkgOptions, PkgBackgroundOptions, BackgroundAlignment, BackgroundScaling } from \"./options/pkgOptions\"\r\nexport { WindowsConfiguration } from \"./options/winOptions\"\r\nexport { AppXOptions } from \"./options/AppXOptions\"\r\nexport { MsiOptions } from \"./options/MsiOptions\"\r\nexport { CommonWindowsInstallerConfiguration } from \"./options/CommonWindowsInstallerConfiguration\"\r\nexport { NsisOptions, NsisWebOptions, PortableOptions, CommonNsisOptions } from \"./targets/nsis/nsisOptions\"\r\nexport { LinuxConfiguration, DebOptions, CommonLinuxOptions, LinuxTargetSpecificOptions, AppImageOptions } from \"./options/linuxOptions\"\r\nexport { SnapOptions } from \"./options/SnapOptions\"\r\nexport { Metadata, AuthorMetadata, RepositoryInfo } from \"./options/metadata\"\r\nexport { AppInfo } from \"./appInfo\"\r\nexport { SquirrelWindowsOptions } from \"./options/SquirrelWindowsOptions\"\r\nexport { WindowsSignOptions, CustomWindowsSignTaskConfiguration, WindowsSignTaskConfiguration, CustomWindowsSign, FileCodeSigningInfo, CertificateFromStoreInfo } from \"./codeSign/windowsCodeSign\"\r\nexport { CancellationToken, ProgressInfo } from \"builder-util-runtime\"\r\nexport { PublishOptions, UploadTask } from \"electron-publish\"\r\nexport { PublishManager } from \"./publish/PublishManager\"\r\nexport { PlatformPackager } from \"./platformPackager\"\r\nexport { Framework, PrepareApplicationStageDirectoryOptions } from \"./Framework\"\r\nexport { buildForge, ForgeOptions } from \"./forge-maker\"\r\n\r\nconst expectedOptions = new Set([\"publish\", \"targets\", \"mac\", \"win\", \"linux\", \"projectDir\", \"platformPackagerFactory\", \"config\", \"effectiveOptionComputed\", \"prepackaged\"])\r\n\r\nexport function checkBuildRequestOptions(options: PackagerOptions & PublishOptions) {\r\n  for (const optionName of Object.keys(options)) {\r\n    if (!expectedOptions.has(optionName) && (options as any)[optionName] !== undefined) {\r\n      throw new InvalidConfigurationError(`Unknown option \"${optionName}\"`)\r\n    }\r\n  }\r\n}\r\n\r\nexport function build(options: PackagerOptions & PublishOptions, packager: Packager = new Packager(options)): Promise<Array<string>> {\r\n  checkBuildRequestOptions(options)\r\n\r\n  const publishManager = new PublishManager(packager, options)\r\n  const sigIntHandler = () => {\r\n    log.warn(\"cancelled by SIGINT\")\r\n    packager.cancellationToken.cancel()\r\n    publishManager.cancelTasks()\r\n  }\r\n  process.once(\"SIGINT\", sigIntHandler)\r\n\r\n  const promise = packager.build()\r\n    .then(async buildResult => {\r\n      const afterAllArtifactBuild = resolveFunction(buildResult.configuration.afterAllArtifactBuild, \"afterAllArtifactBuild\")\r\n      if (afterAllArtifactBuild != null) {\r\n        const newArtifacts = asArray(await Promise.resolve(afterAllArtifactBuild(buildResult)))\r\n        if (newArtifacts.length === 0 || !publishManager.isPublish) {\r\n          return buildResult.artifactPaths\r\n        }\r\n\r\n        const publishConfigurations = await publishManager.getGlobalPublishConfigurations()\r\n        if (publishConfigurations == null || publishConfigurations.length === 0) {\r\n          return buildResult.artifactPaths\r\n        }\r\n\r\n        for (const newArtifact of newArtifacts) {\r\n          buildResult.artifactPaths.push(newArtifact)\r\n          for (const publishConfiguration of publishConfigurations) {\r\n            publishManager.scheduleUpload(publishConfiguration, {\r\n              file: newArtifact,\r\n              arch: null\r\n            }, packager.appInfo)\r\n          }\r\n        }\r\n      }\r\n      return buildResult.artifactPaths\r\n    })\r\n\r\n  return executeFinally(promise, isErrorOccurred => {\r\n    let promise: Promise<any>\r\n    if (isErrorOccurred) {\r\n      publishManager.cancelTasks()\r\n      promise = Promise.resolve(null)\r\n    }\r\n    else {\r\n      promise = publishManager.awaitTasks()\r\n    }\r\n\r\n    return promise\r\n      .then(() => process.removeListener(\"SIGINT\", sigIntHandler))\r\n  })\r\n}"],"sourceRoot":""}
