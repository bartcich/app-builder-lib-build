{"version":3,"sources":["../../src/electron/ElectronFramework.ts"],"names":[],"mappings":"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","sourcesContent":["import BluebirdPromise from \"bluebird-lst\"\r\nimport { asArray, executeAppBuilder, log } from \"builder-util\"\r\nimport { CONCURRENCY, copyDir, DO_NOT_USE_HARD_LINKS, statOrNull, unlinkIfExists } from \"builder-util/out/fs\"\r\nimport { emptyDir, readdir, remove, rename } from \"fs-extra-p\"\r\nimport { Lazy } from \"lazy-val\"\r\nimport * as path from \"path\"\r\nimport * as semver from \"semver\"\r\nimport { Configuration } from \"../configuration\"\r\nimport { BeforeCopyExtraFilesOptions, Framework, PrepareApplicationStageDirectoryOptions } from \"../Framework\"\r\nimport { ElectronPlatformName, Packager, Platform } from \"../index\"\r\nimport { LinuxPackager } from \"../linuxPackager\"\r\nimport MacPackager from \"../macPackager\"\r\nimport { getTemplatePath } from \"../util/pathManager\"\r\nimport { createMacApp } from \"./electronMac\"\r\nimport { computeElectronVersion, getElectronVersionFromInstalled } from \"./electronVersion\"\r\n\r\nexport type ElectronPlatformName = \"darwin\" | \"linux\" | \"win32\" | \"mas\"\r\n\r\nexport interface ElectronDownloadOptions {\r\n  // https://github.com/electron-userland/electron-builder/issues/3077\r\n  // must be optional\r\n  version?: string\r\n\r\n  /**\r\n   * The [cache location](https://github.com/electron-userland/electron-download#cache-location).\r\n   */\r\n  cache?: string | null\r\n\r\n  /**\r\n   * The mirror.\r\n   */\r\n  mirror?: string | null\r\n\r\n  /** @private */\r\n  customDir?: string | null\r\n  /** @private */\r\n  customFilename?: string | null\r\n\r\n  strictSSL?: boolean\r\n  isVerifyChecksum?: boolean\r\n\r\n  platform?: ElectronPlatformName\r\n  arch?: string\r\n}\r\n\r\nfunction createDownloadOpts(opts: Configuration, platform: ElectronPlatformName, arch: string, electronVersion: string): ElectronDownloadOptions {\r\n  return {\r\n    platform,\r\n    arch,\r\n    version: electronVersion,\r\n    ...opts.electronDownload,\r\n  }\r\n}\r\n\r\nasync function beforeCopyExtraFiles(options: BeforeCopyExtraFilesOptions, isClearExecStack: boolean) {\r\n  const packager = options.packager\r\n  const appOutDir = options.appOutDir\r\n  if (packager.platform === Platform.LINUX) {\r\n    const linuxPackager = (packager as LinuxPackager)\r\n    const executable = path.join(appOutDir, linuxPackager.executableName)\r\n    await rename(path.join(appOutDir, packager.electronDistExecutableName), executable)\r\n\r\n    if (isClearExecStack) {\r\n      try {\r\n        await executeAppBuilder([\"clear-exec-stack\", \"--input\", executable])\r\n      }\r\n      catch (e) {\r\n        log.debug({error: e}, \"cannot clear exec stack\")\r\n      }\r\n    }\r\n  }\r\n  else if (packager.platform === Platform.WINDOWS) {\r\n    const executable = path.join(appOutDir, `${packager.appInfo.productFilename}.exe`)\r\n    await rename(path.join(appOutDir, `${packager.electronDistExecutableName}.exe`), executable)\r\n  }\r\n  else {\r\n    await createMacApp(packager as MacPackager, appOutDir, options.asarIntegrity, (options.platformName as ElectronPlatformName) === \"mas\")\r\n\r\n    const wantedLanguages = asArray(packager.platformSpecificBuildOptions.electronLanguages)\r\n    if (wantedLanguages.length === 0) {\r\n      return\r\n    }\r\n\r\n    // noinspection SpellCheckingInspection\r\n    const langFileExt = \".lproj\"\r\n    const resourcesDir = packager.getResourcesDir(appOutDir)\r\n    await BluebirdPromise.map(readdir(resourcesDir), file => {\r\n      if (!file.endsWith(langFileExt)) {\r\n        return\r\n      }\r\n\r\n      const language = file.substring(0, file.length - langFileExt.length)\r\n      if (!wantedLanguages.includes(language)) {\r\n        return remove(path.join(resourcesDir, file))\r\n      }\r\n      return\r\n    }, CONCURRENCY)\r\n  }\r\n}\r\n\r\nclass ElectronFramework implements Framework {\r\n  // noinspection JSUnusedGlobalSymbols\r\n  readonly macOsDefaultTargets = [\"zip\", \"dmg\"]\r\n  // noinspection JSUnusedGlobalSymbols\r\n  readonly defaultAppIdPrefix = \"com.electron.\"\r\n  // noinspection JSUnusedGlobalSymbols\r\n  readonly isCopyElevateHelper = true\r\n  // noinspection JSUnusedGlobalSymbols\r\n  readonly isNpmRebuildRequired = true\r\n\r\n  constructor(readonly name: string, readonly version: string, readonly distMacOsAppName: string) {\r\n  }\r\n\r\n  getDefaultIcon(platform: Platform) {\r\n    if (platform === Platform.LINUX) {\r\n      return path.join(getTemplatePath(\"icons\"), \"electron-linux\")\r\n    }\r\n    else {\r\n      // default icon is embedded into app skeleton\r\n      return null\r\n    }\r\n  }\r\n\r\n  prepareApplicationStageDirectory(options: PrepareApplicationStageDirectoryOptions) {\r\n    return unpack(options, createDownloadOpts(options.packager.config, options.platformName, options.arch, this.version), this.distMacOsAppName)\r\n  }\r\n\r\n  beforeCopyExtraFiles(options: BeforeCopyExtraFilesOptions) {\r\n    return beforeCopyExtraFiles(options, this.name === \"electron\" && semver.lte(this.version || \"1.8.3\", \"1.8.3\"))\r\n  }\r\n}\r\n\r\nclass MuonFramework extends ElectronFramework {\r\n  constructor(version: string) {\r\n    super(\"muon\", version, \"Brave.app\")\r\n  }\r\n\r\n  prepareApplicationStageDirectory(options: PrepareApplicationStageDirectoryOptions) {\r\n    return unpack(options, {\r\n      mirror: \"https://github.com/brave/muon/releases/download/v\",\r\n      customFilename: `brave-v${options.version}-${options.platformName}-${options.arch}.zip`,\r\n      isVerifyChecksum: false,\r\n      ...createDownloadOpts(options.packager.config, options.platformName, options.arch, options.version),\r\n    }, this.distMacOsAppName)\r\n  }\r\n}\r\n\r\nexport async function createElectronFrameworkSupport(configuration: Configuration, packager: Packager): Promise<Framework> {\r\n  if (configuration.muonVersion != null) {\r\n    return new MuonFramework(configuration.muonVersion!!)\r\n  }\r\n\r\n  let version = configuration.electronVersion\r\n  if (version == null) {\r\n    // for prepacked app asar no dev deps in the app.asar\r\n    if (packager.isPrepackedAppAsar) {\r\n      version = await getElectronVersionFromInstalled(packager.projectDir)\r\n      if (version == null) {\r\n        throw new Error(`Cannot compute electron version for prepacked asar`)\r\n      }\r\n    }\r\n    else {\r\n      version = await computeElectronVersion(packager.projectDir, new Lazy(() => Promise.resolve(packager.metadata)))\r\n    }\r\n    configuration.electronVersion = version\r\n  }\r\n\r\n  return new ElectronFramework(\"electron\", version, \"Electron.app\")\r\n}\r\n\r\nasync function unpack(prepareOptions: PrepareApplicationStageDirectoryOptions, options: ElectronDownloadOptions, distMacOsAppName: string) {\r\n  const packager = prepareOptions.packager\r\n  const out = prepareOptions.appOutDir\r\n\r\n  let dist: string | null | undefined = packager.config.electronDist\r\n  if (dist != null) {\r\n    const zipFile = `electron-v${options.version}-${prepareOptions.platformName}-${options.arch}.zip`\r\n    const resolvedDist = path.resolve(packager.projectDir, dist)\r\n    if ((await statOrNull(path.join(resolvedDist, zipFile))) != null) {\r\n      options.cache = resolvedDist\r\n      dist = null\r\n    }\r\n  }\r\n\r\n  let isFullCleanup = false\r\n  if (dist == null) {\r\n    await executeAppBuilder([\"unpack-electron\", \"--configuration\", JSON.stringify([options]), \"--output\", out, \"--distMacOsAppName\", distMacOsAppName])\r\n  }\r\n  else {\r\n    isFullCleanup = true\r\n    const source = packager.getElectronSrcDir(dist)\r\n    const destination = packager.getElectronDestinationDir(out)\r\n    log.info({source, destination}, \"copying Electron\")\r\n    await emptyDir(out)\r\n    await copyDir(source, destination, {\r\n      isUseHardLink: DO_NOT_USE_HARD_LINKS,\r\n    })\r\n  }\r\n\r\n  await cleanupAfterUnpack(prepareOptions, distMacOsAppName, isFullCleanup)\r\n}\r\n\r\nfunction cleanupAfterUnpack(prepareOptions: PrepareApplicationStageDirectoryOptions, distMacOsAppName: string, isFullCleanup: boolean) {\r\n  const out = prepareOptions.appOutDir\r\n  const isMac = prepareOptions.packager.platform === Platform.MAC\r\n  const resourcesPath = isMac ? path.join(out, distMacOsAppName, \"Contents\", \"Resources\") : path.join(out, \"resources\")\r\n\r\n  return Promise.all([\r\n    isFullCleanup ? unlinkIfExists(path.join(resourcesPath, \"default_app.asar\")) : Promise.resolve(),\r\n    isFullCleanup ? unlinkIfExists(path.join(out, \"version\")) : Promise.resolve(),\r\n    isMac ? Promise.resolve() : rename(path.join(out, \"LICENSE\"), path.join(out, \"LICENSE.electron.txt\")).catch(() => {/* ignore */}),\r\n  ])\r\n}"],"sourceRoot":""}
