{"version":3,"sources":["../../src/electron/electronMac.ts"],"names":[],"mappings":"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","sourcesContent":["import BluebirdPromise from \"bluebird-lst\"\r\nimport { asArray, getPlatformIconFileName, InvalidConfigurationError, log } from \"builder-util\"\r\nimport { copyOrLinkFile, unlinkIfExists } from \"builder-util/out/fs\"\r\nimport { orIfFileNotExist } from \"builder-util/out/promise\"\r\nimport { readFile, rename, utimes, writeFile } from \"fs-extra-p\"\r\nimport * as path from \"path\"\r\nimport { build as buildPlist, parse as parsePlist } from \"plist\"\r\nimport { filterCFBundleIdentifier } from \"../appInfo\"\r\nimport { AsarIntegrity } from \"../asar/integrity\"\r\nimport MacPackager from \"../macPackager\"\r\nimport { normalizeExt } from \"../platformPackager\"\r\n\r\nfunction doRename(basePath: string, oldName: string, newName: string) {\r\n  return rename(path.join(basePath, oldName), path.join(basePath, newName))\r\n}\r\n\r\nfunction moveHelpers(helperSuffixes: Array<string>, frameworksPath: string, appName: string, prefix: string): Promise<any> {\r\n  return BluebirdPromise.map(helperSuffixes, suffix => {\r\n    const executableBasePath = path.join(frameworksPath, `${prefix}${suffix}.app`, \"Contents\", \"MacOS\")\r\n    return doRename(executableBasePath, `${prefix}${suffix}`, appName + suffix)\r\n      .then(() => doRename(frameworksPath, `${prefix}${suffix}.app`, `${appName}${suffix}.app`))\r\n  })\r\n}\r\n\r\nfunction getAvailableHelperSuffixes(helperEHPlist: string | null, helperNPPlist: string | null) {\r\n  const result = [\" Helper\"]\r\n  if (helperEHPlist != null) {\r\n    result.push(\" Helper EH\")\r\n  }\r\n  if (helperNPPlist != null) {\r\n    result.push(\" Helper NP\")\r\n  }\r\n  return result\r\n}\r\n\r\n/** @internal */\r\nexport async function createMacApp(packager: MacPackager, appOutDir: string, asarIntegrity: AsarIntegrity | null, isMas: boolean) {\r\n  const appInfo = packager.appInfo\r\n  const appFilename = appInfo.productFilename\r\n\r\n  const contentsPath = path.join(appOutDir, packager.info.framework.distMacOsAppName, \"Contents\")\r\n  const frameworksPath = path.join(contentsPath, \"Frameworks\")\r\n  const loginItemPath = path.join(contentsPath, \"Library\", \"LoginItems\")\r\n\r\n  const appPlistFilename = path.join(contentsPath, \"Info.plist\")\r\n  const helperPlistFilename = path.join(frameworksPath, `${packager.electronDistMacOsExecutableName} Helper.app`, \"Contents\", \"Info.plist\")\r\n  const helperEHPlistFilename = path.join(frameworksPath, `${packager.electronDistMacOsExecutableName} Helper EH.app`, \"Contents\", \"Info.plist\")\r\n  const helperNPPlistFilename = path.join(frameworksPath, `${packager.electronDistMacOsExecutableName} Helper NP.app`, \"Contents\", \"Info.plist\")\r\n  const helperLoginPlistFilename = path.join(loginItemPath, `${packager.electronDistMacOsExecutableName} Login Helper.app`, \"Contents\", \"Info.plist\")\r\n\r\n  const buildMetadata = packager.config!\r\n  const fileContents: Array<string | null> = await BluebirdPromise.map([\r\n    appPlistFilename,\r\n    helperPlistFilename,\r\n    helperEHPlistFilename,\r\n    helperNPPlistFilename,\r\n    helperLoginPlistFilename,\r\n    (buildMetadata as any)[\"extend-info\"]\r\n  ], it => it == null ? it : orIfFileNotExist(readFile(it, \"utf8\"), null))\r\n  const appPlist = parsePlist(fileContents[0]!!)\r\n  const helperPlist = parsePlist(fileContents[1]!!)\r\n  const helperEHPlist = fileContents[2] == null ? null : parsePlist(fileContents[2]!!)\r\n  const helperNPPlist = fileContents[3] == null ? null : parsePlist(fileContents[3]!!)\r\n  const helperLoginPlist = fileContents[4] == null ? null : parsePlist(fileContents[4]!!)\r\n\r\n  // if an extend-info file was supplied, copy its contents in first\r\n  if (fileContents[5] != null) {\r\n    Object.assign(appPlist, parsePlist(fileContents[5]!!))\r\n  }\r\n\r\n  const oldHelperBundleId = (buildMetadata as any)[\"helper-bundle-id\"]\r\n  if (oldHelperBundleId != null) {\r\n    log.warn(\"build.helper-bundle-id is deprecated, please set as build.mac.helperBundleId\")\r\n  }\r\n  const helperBundleIdentifier = filterCFBundleIdentifier(packager.platformSpecificBuildOptions.helperBundleId || oldHelperBundleId || `${appInfo.macBundleIdentifier}.helper`)\r\n\r\n  await packager.applyCommonInfo(appPlist, contentsPath)\r\n\r\n  // required for electron-updater proxy\r\n  if (!isMas) {\r\n    configureLocalhostAts(appPlist)\r\n  }\r\n\r\n  helperPlist.CFBundleExecutable = `${appFilename} Helper`\r\n  helperPlist.CFBundleDisplayName = `${appInfo.productName} Helper`\r\n  helperPlist.CFBundleIdentifier = helperBundleIdentifier\r\n  helperPlist.CFBundleVersion = appPlist.CFBundleVersion\r\n\r\n  function configureHelper(helper: any, postfix: string) {\r\n    helper.CFBundleExecutable = `${appFilename} Helper ${postfix}`\r\n    helper.CFBundleDisplayName = `${appInfo.productName} Helper ${postfix}`\r\n    helper.CFBundleIdentifier = `${helperBundleIdentifier}.${postfix}`\r\n    helper.CFBundleVersion = appPlist.CFBundleVersion\r\n  }\r\n\r\n  if (helperEHPlist != null) {\r\n    configureHelper(helperEHPlist, \"EH\")\r\n  }\r\n  if (helperNPPlist != null) {\r\n    configureHelper(helperNPPlist, \"NP\")\r\n  }\r\n  if (helperLoginPlist != null) {\r\n    helperLoginPlist.CFBundleExecutable = `${appFilename} Login Helper`\r\n    helperLoginPlist.CFBundleDisplayName = `${appInfo.productName} Login Helper`\r\n    // noinspection SpellCheckingInspection\r\n    helperLoginPlist.CFBundleIdentifier = `${appInfo.macBundleIdentifier}.loginhelper`\r\n    helperLoginPlist.CFBundleVersion = appPlist.CFBundleVersion\r\n  }\r\n\r\n  const protocols = asArray(buildMetadata.protocols).concat(asArray(packager.platformSpecificBuildOptions.protocols))\r\n  if (protocols.length > 0) {\r\n    appPlist.CFBundleURLTypes = protocols.map(protocol => {\r\n      const schemes = asArray(protocol.schemes)\r\n      if (schemes.length === 0) {\r\n        throw new InvalidConfigurationError(`Protocol \"${protocol.name}\": must be at least one scheme specified`)\r\n      }\r\n      return {\r\n        CFBundleURLName: protocol.name,\r\n        CFBundleTypeRole: protocol.role || \"Editor\",\r\n        CFBundleURLSchemes: schemes.slice()\r\n      }\r\n    })\r\n  }\r\n\r\n  const fileAssociations = packager.fileAssociations\r\n  if (fileAssociations.length > 0) {\r\n    appPlist.CFBundleDocumentTypes = await BluebirdPromise.map(fileAssociations, async fileAssociation => {\r\n      const extensions = asArray(fileAssociation.ext).map(normalizeExt)\r\n      const customIcon = await packager.getResource(getPlatformIconFileName(fileAssociation.icon, true), `${extensions[0]}.icns`)\r\n      let iconFile = appPlist.CFBundleIconFile\r\n      if (customIcon != null) {\r\n        iconFile = path.basename(customIcon)\r\n        await copyOrLinkFile(customIcon, path.join(path.join(contentsPath, \"Resources\"), iconFile))\r\n      }\r\n\r\n      const result = {\r\n        CFBundleTypeExtensions: extensions,\r\n        CFBundleTypeName: fileAssociation.name || extensions[0],\r\n        CFBundleTypeRole: fileAssociation.role || \"Editor\",\r\n        CFBundleTypeIconFile: iconFile\r\n      } as any\r\n\r\n      if (fileAssociation.isPackage) {\r\n        result.LSTypeIsPackage = true\r\n      }\r\n      return result\r\n    })\r\n  }\r\n\r\n  if (asarIntegrity != null) {\r\n    appPlist.AsarIntegrity = JSON.stringify(asarIntegrity)\r\n  }\r\n\r\n  await Promise.all([\r\n    writeFile(appPlistFilename, buildPlist(appPlist)),\r\n    writeFile(helperPlistFilename, buildPlist(helperPlist)),\r\n    helperEHPlist == null ? Promise.resolve() : writeFile(helperEHPlistFilename, buildPlist(helperEHPlist)),\r\n    helperNPPlist == null ? Promise.resolve() : writeFile(helperNPPlistFilename, buildPlist(helperNPPlist)),\r\n    helperLoginPlist == null ? Promise.resolve() : writeFile(helperLoginPlistFilename, buildPlist(helperLoginPlist)),\r\n    doRename(path.join(contentsPath, \"MacOS\"), packager.electronDistMacOsExecutableName, appPlist.CFBundleExecutable),\r\n    unlinkIfExists(path.join(appOutDir, \"LICENSE\")),\r\n    unlinkIfExists(path.join(appOutDir, \"LICENSES.chromium.html\")),\r\n  ])\r\n\r\n  await moveHelpers(getAvailableHelperSuffixes(helperEHPlist, helperNPPlist), frameworksPath, appFilename, packager.electronDistMacOsExecutableName)\r\n\r\n  if (helperLoginPlist != null) {\r\n    const prefix = packager.electronDistMacOsExecutableName\r\n    const suffix = \" Login Helper\"\r\n    const executableBasePath = path.join(loginItemPath, `${prefix}${suffix}.app`, \"Contents\", \"MacOS\")\r\n    await doRename(executableBasePath, `${prefix}${suffix}`, appFilename + suffix)\r\n      .then(() => doRename(loginItemPath, `${prefix}${suffix}.app`, `${appFilename}${suffix}.app`))\r\n  }\r\n\r\n  const appPath = path.join(appOutDir, `${appFilename}.app`)\r\n  await rename(path.dirname(contentsPath), appPath)\r\n  // https://github.com/electron-userland/electron-builder/issues/840\r\n  const now = Date.now() / 1000\r\n  await utimes(appPath, now, now)\r\n}\r\n\r\nfunction configureLocalhostAts(appPlist: any) {\r\n  // https://bencoding.com/2015/07/20/app-transport-security-and-localhost/\r\n  let ats = appPlist.NSAppTransportSecurity\r\n  if (ats == null) {\r\n    ats = {}\r\n    appPlist.NSAppTransportSecurity = ats\r\n  }\r\n\r\n  ats.NSAllowsLocalNetworking = true\r\n  // https://github.com/electron-userland/electron-builder/issues/3377#issuecomment-446035814\r\n  ats.NSAllowsArbitraryLoads = true\r\n\r\n  let exceptionDomains = ats.NSExceptionDomains\r\n  if (exceptionDomains == null) {\r\n    exceptionDomains = {}\r\n    ats.NSExceptionDomains = exceptionDomains\r\n  }\r\n\r\n  if (exceptionDomains.localhost == null) {\r\n    const allowHttp = {\r\n      NSTemporaryExceptionAllowsInsecureHTTPSLoads: false,\r\n      NSIncludesSubdomains: false,\r\n      NSTemporaryExceptionAllowsInsecureHTTPLoads: true,\r\n      NSTemporaryExceptionMinimumTLSVersion: \"1.0\",\r\n      NSTemporaryExceptionRequiresForwardSecrecy: false\r\n    }\r\n    exceptionDomains.localhost = allowHttp\r\n    exceptionDomains[\"127.0.0.1\"] = allowHttp\r\n  }\r\n}"],"sourceRoot":""}
