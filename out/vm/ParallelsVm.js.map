{"version":3,"sources":["../../src/vm/ParallelsVm.ts"],"names":[],"mappings":"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","sourcesContent":["import { exec, spawn, DebugLogger, ExtraSpawnOptions, log } from \"builder-util\"\r\nimport { SpawnOptions, execFileSync, ExecFileOptions } from \"child_process\"\r\nimport { VmManager } from \"./vm\"\r\n\r\n/** @internal */\r\nexport async function parseVmList(debugLogger: DebugLogger) {\r\n  // do not log output if debug - it is huge, logged using debugLogger\r\n  let rawList = await exec(\"prlctl\", [\"list\", \"-i\", \"-s\", \"name\"], undefined, false)\r\n  debugLogger.add(\"parallels.list\", rawList)\r\n\r\n  rawList = rawList.substring(rawList.indexOf(\"ID:\"))\r\n\r\n  // let match: Array<string> | null\r\n  const result: Array<ParallelsVm> = []\r\n  for (const info of rawList.split(\"\\n\\n\").map(it => it.trim()).filter(it => it.length > 0)) {\r\n    const vm: any = {}\r\n    for (const line of info.split(\"\\n\")) {\r\n      const meta = /^([^:(\"]+): (.*)$/.exec(line)\r\n      if (meta == null) {\r\n        continue\r\n      }\r\n\r\n      const key = meta[1].toLowerCase()\r\n      if (key === \"id\" || key === \"os\" || key === \"name\" || key === \"state\" || key === \"name\") {\r\n        vm[key] = meta[2].trim()\r\n      }\r\n    }\r\n    result.push(vm)\r\n  }\r\n  return result\r\n}\r\n\r\n/** @internal */\r\nexport class ParallelsVmManager extends VmManager {\r\n  private startPromise: Promise<any>\r\n\r\n  private isExitHookAdded = false\r\n\r\n  constructor(private readonly vm: ParallelsVm) {\r\n    super()\r\n\r\n    this.startPromise = this.doStartVm()\r\n  }\r\n\r\n  get pathSep(): string {\r\n    return \"/\"\r\n  }\r\n\r\n  private handleExecuteError(error: Error): any {\r\n    if (error.message.includes(\"Unable to open new session in this virtual machine\")) {\r\n      throw new Error(`Please ensure that your are logged in \"${this.vm.name}\" parallels virtual machine. In the future please do not stop VM, but suspend.\\n\\n${error.message}`)\r\n    }\r\n\r\n    log.warn(\"ensure that 'Share folders' is set to 'All Disks', see https://goo.gl/E6XphP\")\r\n    throw error\r\n  }\r\n\r\n  async exec(file: string, args: Array<string>, options?: ExecFileOptions): Promise<string> {\r\n    await this.ensureThatVmStarted()\r\n    // it is important to use \"--current-user\" to execute command under logged in user - to access certs.\r\n    return await exec(\"prlctl\", [\"exec\", this.vm.id, \"--current-user\", file.startsWith(\"/\") ? macPathToParallelsWindows(file) : file].concat(args), options)\r\n      .catch(error => this.handleExecuteError(error))\r\n  }\r\n\r\n  async spawn(file: string, args: Array<string>, options?: SpawnOptions, extraOptions?: ExtraSpawnOptions): Promise<any> {\r\n    await this.ensureThatVmStarted()\r\n    return await spawn(\"prlctl\", [\"exec\", this.vm.id, file].concat(args), options, extraOptions)\r\n      .catch(error => this.handleExecuteError(error))\r\n  }\r\n\r\n  private async doStartVm() {\r\n    const vmId = this.vm.id\r\n    const state = this.vm.state\r\n    if (state === \"running\") {\r\n      return\r\n    }\r\n\r\n    if (!this.isExitHookAdded) {\r\n      this.isExitHookAdded = true\r\n      require(\"async-exit-hook\")((callback: (() => void) | null) => {\r\n        const stopArgs = [\"suspend\", vmId]\r\n        if (callback == null) {\r\n          execFileSync(\"prlctl\", stopArgs)\r\n        }\r\n        else {\r\n          exec(\"prlctl\", stopArgs)\r\n            .then(callback)\r\n            .catch(callback)\r\n        }\r\n      })\r\n    }\r\n    await exec(\"prlctl\", [\"start\", vmId])\r\n  }\r\n\r\n  private ensureThatVmStarted() {\r\n    let startPromise = this.startPromise\r\n    if (startPromise == null) {\r\n      startPromise = this.doStartVm()\r\n      this.startPromise = startPromise\r\n    }\r\n    return startPromise\r\n  }\r\n\r\n  toVmFile(file: string): string {\r\n    // https://stackoverflow.com/questions/4742992/cannot-access-network-drive-in-powershell-running-as-administrator\r\n    return macPathToParallelsWindows(file)\r\n  }\r\n}\r\n\r\nexport function macPathToParallelsWindows(file: string) {\r\n  if (file.startsWith(\"C:\\\\\")) {\r\n    return file\r\n  }\r\n  return \"\\\\\\\\Mac\\\\Host\\\\\" + file.replace(/\\//g, \"\\\\\")\r\n}\r\n\r\nexport interface ParallelsVm {\r\n  id: string\r\n  name: string\r\n  os: \"win-10\" | \"ubuntu\" | \"elementary\"\r\n  state: \"running\" | \"suspended\" | \"stopped\"\r\n}"],"sourceRoot":""}
