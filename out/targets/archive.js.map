{"version":3,"sources":["../../src/targets/archive.ts"],"names":[],"mappings":"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","sourcesContent":["import { path7za } from \"7zip-bin\"\r\nimport { debug7z, exec } from \"builder-util\"\r\nimport { exists, unlinkIfExists } from \"builder-util/out/fs\"\r\nimport { move } from \"fs-extra-p\"\r\nimport * as path from \"path\"\r\nimport { TmpDir } from \"temp-file\"\r\nimport { CompressionLevel } from \"../core\"\r\nimport { getLinuxToolsPath } from \"./tools\"\r\n\r\n/** @internal */\r\nexport async function tar(compression: CompressionLevel | any | any, format: string, outFile: string, dirToArchive: string, isMacApp: boolean, tempDirManager: TmpDir): Promise<void> {\r\n  const tarFile = await tempDirManager.getTempFile({suffix: \".tar\"})\r\n  const tarArgs = debug7zArgs(\"a\")\r\n  tarArgs.push(tarFile)\r\n  tarArgs.push(path.basename(dirToArchive))\r\n\r\n  await Promise.all([\r\n    exec(path7za, tarArgs, {cwd: path.dirname(dirToArchive)}),\r\n    // remove file before - 7z doesn't overwrite file, but update\r\n    unlinkIfExists(outFile),\r\n  ])\r\n\r\n  if (!isMacApp) {\r\n    await exec(path7za, [\"rn\", tarFile, path.basename(dirToArchive), path.basename(outFile, `.${format}`)])\r\n  }\r\n\r\n  if (format === \"tar.lz\") {\r\n    // noinspection SpellCheckingInspection\r\n    let lzipPath = \"lzip\"\r\n    if (process.platform === \"darwin\") {\r\n      lzipPath = path.join(await getLinuxToolsPath(), \"bin\", lzipPath)\r\n    }\r\n    await exec(lzipPath, [compression === \"store\" ? \"-1\" : \"-9\", \"--keep\" /* keep (don't delete) input files */, tarFile])\r\n    // bloody lzip creates file in the same dir where input file with postfix `.lz`, option --output doesn't work\r\n    await move(`${tarFile}.lz`, outFile)\r\n    return\r\n  }\r\n\r\n  const args = compute7zCompressArgs(format === \"tar.xz\" ? \"xz\" : (format === \"tar.bz2\" ? \"bzip2\" : \"gzip\"), {\r\n    isRegularFile: true,\r\n    method: \"DEFAULT\",\r\n    compression,\r\n  })\r\n  args.push(outFile, tarFile)\r\n  await exec(path7za, args, {\r\n    cwd: path.dirname(dirToArchive),\r\n  }, debug7z.enabled)\r\n}\r\n\r\nexport interface ArchiveOptions {\r\n  compression?: CompressionLevel | null\r\n\r\n  /**\r\n   * @default false\r\n   */\r\n  withoutDir?: boolean\r\n\r\n  /**\r\n   * @default true\r\n   */\r\n  solid?: boolean\r\n\r\n  /**\r\n   * @default true\r\n   */\r\n  isArchiveHeaderCompressed?: boolean\r\n\r\n  dictSize?: number\r\n  excluded?: Array<string> | null\r\n\r\n  // DEFAULT allows to disable custom logic and do not pass method switch at all\r\n  method?: \"Copy\" | \"LZMA\" | \"Deflate\" | \"DEFAULT\"\r\n\r\n  isRegularFile?: boolean\r\n}\r\n\r\nexport function compute7zCompressArgs(format: string, options: ArchiveOptions = {}) {\r\n  let storeOnly = options.compression === \"store\"\r\n  const args = debug7zArgs(\"a\")\r\n\r\n  let isLevelSet = false\r\n  if (process.env.ELECTRON_BUILDER_COMPRESSION_LEVEL != null) {\r\n    storeOnly = false\r\n    args.push(`-mx=${process.env.ELECTRON_BUILDER_COMPRESSION_LEVEL}`)\r\n    isLevelSet = true\r\n  }\r\n\r\n  const isZip = format === \"zip\"\r\n  if (!storeOnly) {\r\n    if (isZip && options.compression === \"maximum\") {\r\n      // http://superuser.com/a/742034\r\n      args.push(\"-mfb=258\", \"-mpass=15\")\r\n    }\r\n\r\n    if (!isLevelSet) {\r\n      // https://github.com/electron-userland/electron-builder/pull/3032\r\n      args.push(\"-mx=\" + ((!isZip || options.compression === \"maximum\") ? \"9\" : \"7\"))\r\n    }\r\n  }\r\n\r\n  if (options.dictSize != null) {\r\n    args.push(`-md=${options.dictSize}m`)\r\n  }\r\n\r\n  // https://sevenzip.osdn.jp/chm/cmdline/switches/method.htm#7Z\r\n  // https://stackoverflow.com/questions/27136783/7zip-produces-different-output-from-identical-input\r\n  // tc and ta are off by default, but to be sure, we explicitly set it to off\r\n  // disable \"Stores NTFS timestamps for files: Modification time, Creation time, Last access time.\" to produce the same archive for the same data\r\n  if (!options.isRegularFile) {\r\n    args.push(\"-mtc=off\")\r\n  }\r\n\r\n  if (format === \"7z\" || format.endsWith(\".7z\")) {\r\n    if (options.solid === false) {\r\n      args.push(\"-ms=off\")\r\n    }\r\n\r\n    if (options.isArchiveHeaderCompressed === false) {\r\n      args.push(\"-mhc=off\")\r\n    }\r\n\r\n    // args valid only for 7z\r\n    // -mtm=off disable \"Stores last Modified timestamps for files.\"\r\n    args.push(\"-mtm=off\", \"-mta=off\")\r\n  }\r\n\r\n  if (options.method != null) {\r\n    if (options.method !== \"DEFAULT\") {\r\n      args.push(`-mm=${options.method}`)\r\n    }\r\n  }\r\n  else if (isZip || storeOnly) {\r\n    args.push(`-mm=${storeOnly ? \"Copy\" : \"Deflate\"}`)\r\n  }\r\n\r\n  if (isZip) {\r\n    // -mcu switch:  7-Zip uses UTF-8, if there are non-ASCII symbols.\r\n    // because default mode: 7-Zip uses UTF-8, if the local code page doesn't contain required symbols.\r\n    // but archive should be the same regardless where produced\r\n    args.push(\"-mcu\")\r\n  }\r\n  return args\r\n}\r\n\r\n// 7z is very fast, so, use ultra compression\r\n/** @internal */\r\nexport async function archive(format: string, outFile: string, dirToArchive: string, options: ArchiveOptions = {}): Promise<string> {\r\n  const args = compute7zCompressArgs(format, options)\r\n  // remove file before - 7z doesn't overwrite file, but update\r\n  await unlinkIfExists(outFile)\r\n\r\n  args.push(outFile, options.withoutDir ? \".\" : path.basename(dirToArchive))\r\n  if (options.excluded != null) {\r\n    for (const mask of options.excluded) {\r\n      args.push(`-xr!${mask}`)\r\n    }\r\n  }\r\n\r\n  try {\r\n    await exec(path7za, args, {\r\n      cwd: options.withoutDir ? dirToArchive : path.dirname(dirToArchive),\r\n    }, debug7z.enabled)\r\n  }\r\n  catch (e) {\r\n    if (e.code === \"ENOENT\" && !(await exists(dirToArchive))) {\r\n      throw new Error(`Cannot create archive: \"${dirToArchive}\" doesn't exist`)\r\n    }\r\n    else {\r\n      throw e\r\n    }\r\n  }\r\n\r\n  return outFile\r\n}\r\n\r\nfunction debug7zArgs(command: \"a\" | \"x\"): Array<string> {\r\n  const args = [command, \"-bd\"]\r\n  if (debug7z.enabled) {\r\n    args.push(\"-bb\")\r\n  }\r\n  return args\r\n}"],"sourceRoot":""}
