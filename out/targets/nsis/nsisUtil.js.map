{"version":3,"sources":["../../../src/targets/nsis/nsisUtil.ts"],"names":[],"mappings":"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","sourcesContent":["import BluebirdPromise from \"bluebird-lst\"\r\nimport { Arch, log } from \"builder-util\"\r\nimport { PackageFileInfo } from \"builder-util-runtime\"\r\nimport { getBinFromGithub } from \"../../binDownload\"\r\nimport { copyFile } from \"builder-util/out/fs\"\r\nimport { unlink } from \"fs-extra-p\"\r\nimport { Lazy } from \"lazy-val\"\r\nimport * as path from \"path\"\r\nimport { getTemplatePath } from \"../../util/pathManager\"\r\nimport { NsisTarget } from \"./NsisTarget\"\r\n\r\nexport const nsisTemplatesDir = getTemplatePath(\"nsis\")\r\n\r\nexport const NSIS_PATH = new Lazy(() => {\r\n  const custom = process.env.ELECTRON_BUILDER_NSIS_DIR\r\n  if (custom != null && custom.length > 0) {\r\n    return Promise.resolve(custom.trim())\r\n  }\r\n  // noinspection SpellCheckingInspection\r\n  return getBinFromGithub(\"nsis\", \"3.0.3.2\", \"tUrlDPQtbjcooNbTrjUzLupttWlATLDNWqK57TVr+gAt3wkaxFxBS3k80AzEFJbmSeOWrUooO72FFOVGXcoxhA==\")\r\n})\r\n\r\nexport class AppPackageHelper {\r\n  private readonly archToFileInfo = new Map<Arch, Promise<PackageFileInfo>>()\r\n  private readonly infoToIsDelete = new Map<PackageFileInfo, boolean>()\r\n\r\n  /** @private */\r\n  refCount = 0\r\n\r\n  constructor(private readonly elevateHelper: CopyElevateHelper) {\r\n  }\r\n\r\n  async packArch(arch: Arch, target: NsisTarget): Promise<PackageFileInfo> {\r\n    let infoPromise = this.archToFileInfo.get(arch)\r\n    if (infoPromise == null) {\r\n      const appOutDir = target.archs.get(arch)!\r\n      infoPromise = this.elevateHelper.copy(appOutDir, target)\r\n        .then(() => target.buildAppPackage(appOutDir, arch))\r\n      this.archToFileInfo.set(arch, infoPromise)\r\n    }\r\n\r\n    const info = await infoPromise\r\n    if (target.isWebInstaller) {\r\n      this.infoToIsDelete.set(info, false)\r\n    }\r\n    else if (!this.infoToIsDelete.has(info)) {\r\n      this.infoToIsDelete.set(info, true)\r\n    }\r\n    return info\r\n  }\r\n\r\n  async finishBuild(): Promise<any> {\r\n    if (--this.refCount > 0) {\r\n      return\r\n    }\r\n\r\n    const filesToDelete: Array<string> = []\r\n    for (const [info, isDelete] of this.infoToIsDelete.entries()) {\r\n      if (isDelete) {\r\n        filesToDelete.push(info.path)\r\n      }\r\n    }\r\n\r\n    await BluebirdPromise.map(filesToDelete, it => unlink(it))\r\n  }\r\n}\r\n\r\nexport class CopyElevateHelper {\r\n  private readonly copied = new Map<string, Promise<any>>()\r\n\r\n  copy(appOutDir: string, target: NsisTarget): Promise<any> {\r\n    if (!target.packager.info.framework.isCopyElevateHelper) {\r\n      return Promise.resolve()\r\n    }\r\n\r\n    let isPackElevateHelper = target.options.packElevateHelper\r\n    if (isPackElevateHelper === false && target.options.perMachine === true) {\r\n      isPackElevateHelper = true\r\n      log.warn(\"`packElevateHelper = false` is ignored, because `perMachine` is set to `true`\")\r\n    }\r\n\r\n    if (isPackElevateHelper === false) {\r\n      return Promise.resolve()\r\n    }\r\n\r\n    let promise = this.copied.get(appOutDir)\r\n    if (promise != null) {\r\n      return promise\r\n    }\r\n\r\n    promise = NSIS_PATH.value\r\n      .then(it => {\r\n        const outFile = path.join(appOutDir, \"resources\", \"elevate.exe\")\r\n        const promise = copyFile(path.join(it, \"elevate.exe\"), outFile, false)\r\n        if (target.packager.platformSpecificBuildOptions.signAndEditExecutable !== false) {\r\n          return promise.then(() => target.packager.sign(outFile))\r\n        }\r\n        return promise\r\n      })\r\n    this.copied.set(appOutDir, promise)\r\n    return promise\r\n  }\r\n}"],"sourceRoot":""}
