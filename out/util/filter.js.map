{"version":3,"sources":["../../src/util/filter.ts"],"names":[],"mappings":";;;;;;;;AAGA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;;;AAEA;AACM,SAAU,QAAV,CAAmB,OAAnB,EAAqC;AACzC,QAAM,GAAG,GAAG,OAAO,CAAC,GAApB;;AACA,MAAI,GAAG,CAAC,MAAJ,GAAa,CAAjB,EAAoB;AAClB,WAAO,IAAP;AACD;;AAED,OAAK,MAAM,CAAX,IAAgB,GAAG,CAAC,CAAD,CAAnB,EAAwB;AACtB,QAAI,OAAO,CAAP,KAAa,QAAjB,EAA2B;AACzB,aAAO,IAAP;AACD;AACF;;AAED,SAAO,KAAP;AACD,C,CAED;;;AACA,SAAS,cAAT,CAAwB,CAAxB,EAAiC;AAC/B,SAAO,CAAC,CAAC,MAAF,KAAa,CAAb,IAAkB,CAAC,CAAC,QAAF,CAAW,IAAI,CAAC,GAAhB,CAAlB,GAAyC,CAAzC,GAA8C,CAAC,GAAG,IAAI,CAAC,GAA9D;AACD;;AAED,SAAS,eAAT,CAAyB,IAAzB,EAAuC,eAAvC,EAA8D;AAC5D,MAAI,CAAC,IAAI,CAAC,UAAL,CAAgB,eAAhB,CAAL,EAAuC;AACrC,UAAM,KAAK,GAAG,IAAI,CAAC,OAAL,CAAa,uCAAb,CAAd;;AACA,QAAI,KAAK,GAAG,CAAZ,EAAe;AACb,YAAM,IAAI,KAAJ,CAAU,GAAG,IAAI,kBAAkB,eAAe,EAAlD,CAAN;AACD,KAFD,MAGK;AACH,aAAO,IAAI,CAAC,SAAL,CAAe,KAAK,GAAG;AAAE;AAAzB,OAAP;AACD;AACF;;AAED,MAAI,QAAQ,GAAG,IAAI,CAAC,SAAL,CAAe,eAAe,CAAC,MAA/B,CAAf;;AACA,MAAI,IAAI,CAAC,GAAL,KAAa,IAAjB,EAAuB;AACrB,QAAI,QAAQ,CAAC,UAAT,CAAoB,IAApB,CAAJ,EAA+B;AAC7B;AACA,MAAA,QAAQ,GAAG,QAAQ,CAAC,SAAT,CAAmB,CAAnB,CAAX;AACD;;AACD,IAAA,QAAQ,GAAG,QAAQ,CAAC,OAAT,CAAiB,KAAjB,EAAwB,GAAxB,CAAX;AACD;;AACD,SAAO,QAAP;AACD;AAED;;;AACM,SAAU,YAAV,CAAuB,GAAvB,EAAoC,QAApC,EAAgE,eAAhE,EAAyG;AAC7G,QAAM,eAAe,GAAG,cAAc,CAAC,GAAD,CAAtC;AACA,SAAO,CAAC,IAAD,EAAO,IAAP,KAAe;AACpB,QAAI,GAAG,KAAK,IAAZ,EAAkB;AAChB,aAAO,IAAP;AACD;;AAED,UAAM,QAAQ,GAAG,eAAe,CAAC,IAAD,EAAO,eAAP,CAAhC,CALoB,CAMpB;;AACA,WAAO,YAAY,CAAC,QAAD,EAAW,QAAX,EAAqB,IAArB,CAAZ,KAA2C,eAAe,IAAI,IAAnB,IAA2B,IAAI,CAAC,WAAL,EAA3B,IAAiD,CAAC,YAAY,CAAC,QAAD,EAAW,eAAX,EAA4B,IAA5B,CAAzG,CAAP;AACD,GARD;AASD,C,CAED;;;AACA,SAAS,YAAT,CAAsB,IAAtB,EAAoC,QAApC,EAAgE,IAAhE,EAA2E;AACzE,MAAI,KAAK,GAAG,KAAZ;;AACA,OAAK,MAAM,OAAX,IAAsB,QAAtB,EAAgC;AAC9B;AACA;AACA,QAAI,KAAK,KAAK,OAAO,CAAC,MAAtB,EAA8B;AAC5B;AACD,KAL6B,CAO9B;AACA;;;AACA,IAAA,KAAK,GAAG,OAAO,CAAC,KAAR,CAAc,IAAd,EAAoB,IAAI,CAAC,WAAL,MAAsB,CAAC,OAAO,CAAC,MAAnD,CAAR;AACD;;AACD,SAAO,KAAP;AACD,C","sourcesContent":["import { Filter } from \"builder-util/out/fs\"\r\nimport { Stats } from \"fs-extra-p\"\r\nimport { Minimatch } from \"minimatch\"\r\nimport * as path from \"path\"\r\nimport { NODE_MODULES_PATTERN } from \"../fileTransformer\"\r\n\r\n/** @internal */\r\nexport function hasMagic(pattern: Minimatch) {\r\n  const set = pattern.set\r\n  if (set.length > 1) {\r\n    return true\r\n  }\r\n\r\n  for (const i of set[0]) {\r\n    if (typeof i !== \"string\") {\r\n      return true\r\n    }\r\n  }\r\n\r\n  return false\r\n}\r\n\r\n// sometimes, destination may not contain path separator in the end (path to folder), but the src does. So let's ensure paths have path separators in the end\r\nfunction ensureEndSlash(s: string) {\r\n  return s.length === 0 || s.endsWith(path.sep) ? s : (s + path.sep)\r\n}\r\n\r\nfunction getRelativePath(file: string, srcWithEndSlash: string) {\r\n  if (!file.startsWith(srcWithEndSlash)) {\r\n    const index = file.indexOf(NODE_MODULES_PATTERN)\r\n    if (index < 0) {\r\n      throw new Error(`${file} must be under ${srcWithEndSlash}`)\r\n    }\r\n    else {\r\n      return file.substring(index + 1 /* leading slash */)\r\n    }\r\n  }\r\n\r\n  let relative = file.substring(srcWithEndSlash.length)\r\n  if (path.sep === \"\\\\\") {\r\n    if (relative.startsWith(\"\\\\\")) {\r\n      // windows problem: double backslash, the above substring call removes root path with a single slash, so here can me some leftovers\r\n      relative = relative.substring(1)\r\n    }\r\n    relative = relative.replace(/\\\\/g, \"/\")\r\n  }\r\n  return relative\r\n}\r\n\r\n/** @internal */\r\nexport function createFilter(src: string, patterns: Array<Minimatch>, excludePatterns?: Array<Minimatch> | null): Filter {\r\n  const srcWithEndSlash = ensureEndSlash(src)\r\n  return (file, stat) => {\r\n    if (src === file) {\r\n      return true\r\n    }\r\n\r\n    const relative = getRelativePath(file, srcWithEndSlash)\r\n    // https://github.com/electron-userland/electron-builder/issues/867\r\n    return minimatchAll(relative, patterns, stat) && (excludePatterns == null || stat.isDirectory() || !minimatchAll(relative, excludePatterns, stat))\r\n  }\r\n}\r\n\r\n// https://github.com/joshwnj/minimatch-all/blob/master/index.js\r\nfunction minimatchAll(path: string, patterns: Array<Minimatch>, stat: Stats): boolean {\r\n  let match = false\r\n  for (const pattern of patterns) {\r\n    // If we've got a match, only re-test for exclusions.\r\n    // if we don't have a match, only re-test for inclusions.\r\n    if (match !== pattern.negate) {\r\n      continue\r\n    }\r\n\r\n    // partial match — pattern: foo/bar.txt path: foo — we must allow foo\r\n    // use it only for non-negate patterns: const m = new Minimatch(\"!node_modules/@(electron-download|electron)/**/*\", {dot: true }); m.match(\"node_modules\", true) will return false, but must be true\r\n    match = pattern.match(path, stat.isDirectory() && !pattern.negate)\r\n  }\r\n  return match\r\n}\r\n"],"sourceRoot":""}
