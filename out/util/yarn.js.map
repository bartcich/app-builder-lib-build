{"version":3,"sources":["../../src/util/yarn.ts"],"names":[],"mappings":"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","sourcesContent":["import BluebirdPromise from \"bluebird-lst\"\r\nimport { asArray, log, spawn } from \"builder-util\"\r\nimport { exists } from \"builder-util/out/fs\"\r\nimport { Lazy } from \"lazy-val\"\r\nimport { homedir } from \"os\"\r\nimport * as path from \"path\"\r\nimport { Configuration } from \"../configuration\"\r\nimport { Dependency } from \"./packageDependencies\"\r\n\r\nexport async function installOrRebuild(config: Configuration, appDir: string, options: RebuildOptions, forceInstall: boolean = false) {\r\n  const effectiveOptions = {\r\n    buildFromSource: config.buildDependenciesFromSource === true,\r\n    additionalArgs: asArray(config.npmArgs), ...options\r\n  }\r\n\r\n  if (forceInstall || !(await exists(path.join(appDir, \"node_modules\")))) {\r\n    await installDependencies(appDir, effectiveOptions)\r\n  }\r\n  else {\r\n    await rebuild(appDir, effectiveOptions)\r\n  }\r\n}\r\n\r\nexport interface DesktopFrameworkInfo {\r\n  version: string\r\n  useCustomDist: boolean\r\n}\r\n\r\nfunction getElectronGypCacheDir() {\r\n  return path.join(homedir(), \".electron-gyp\")\r\n}\r\n\r\nexport function getGypEnv(frameworkInfo: DesktopFrameworkInfo, platform: NodeJS.Platform, arch: string, buildFromSource: boolean) {\r\n  const npmConfigArch = arch === \"armv7l\" ? \"arm\" : arch\r\n  const common: any = {\r\n    ...process.env,\r\n    npm_config_arch: npmConfigArch,\r\n    npm_config_target_arch: npmConfigArch,\r\n    npm_config_platform: platform,\r\n    npm_config_build_from_source: buildFromSource,\r\n    // required for node-pre-gyp\r\n    npm_config_target_platform: platform,\r\n    npm_config_update_binary: true,\r\n    npm_config_fallback_to_build: true,\r\n  }\r\n\r\n  if (platform === \"win32\") {\r\n    common.npm_config_target_libc = \"unknown\"\r\n  }\r\n\r\n  if (!frameworkInfo.useCustomDist) {\r\n    return common\r\n  }\r\n\r\n  // https://github.com/nodejs/node-gyp/issues/21\r\n  return {\r\n    ...common,\r\n    npm_config_disturl: \"https://atom.io/download/electron\",\r\n    npm_config_target: frameworkInfo.version,\r\n    npm_config_runtime: \"electron\",\r\n    npm_config_devdir: getElectronGypCacheDir(),\r\n  }\r\n}\r\n\r\nfunction installDependencies(appDir: string, options: RebuildOptions): Promise<any> {\r\n  const platform = options.platform || process.platform\r\n  const arch = options.arch || process.arch\r\n  const additionalArgs = options.additionalArgs\r\n\r\n  log.info({platform, arch, appDir}, `installing production dependencies`)\r\n  let execPath = process.env.npm_execpath || process.env.NPM_CLI_JS\r\n  const execArgs = [\"install\", \"--production\"]\r\n\r\n  if (!isRunningYarn(execPath)) {\r\n    if (process.env.NPM_NO_BIN_LINKS === \"true\") {\r\n      execArgs.push(\"--no-bin-links\")\r\n    }\r\n    execArgs.push(\"--cache-min\", \"999999999\")\r\n  }\r\n\r\n  if (execPath == null) {\r\n    execPath = getPackageToolPath()\r\n  }\r\n  else {\r\n    execArgs.unshift(execPath)\r\n    execPath = process.env.npm_node_execpath || process.env.NODE_EXE || \"node\"\r\n  }\r\n\r\n  if (additionalArgs != null) {\r\n    execArgs.push(...additionalArgs)\r\n  }\r\n  return spawn(execPath, execArgs, {\r\n    cwd: appDir,\r\n    env: getGypEnv(options.frameworkInfo, platform, arch, options.buildFromSource === true),\r\n  })\r\n}\r\n\r\nfunction getPackageToolPath() {\r\n  if (process.env.FORCE_YARN === \"true\") {\r\n    return process.platform === \"win32\" ? \"yarn.cmd\" : \"yarn\"\r\n  }\r\n  else {\r\n    return process.platform === \"win32\" ? \"npm.cmd\" : \"npm\"\r\n  }\r\n}\r\n\r\nfunction isRunningYarn(execPath: string | null | undefined) {\r\n  const userAgent = process.env.npm_config_user_agent\r\n  return process.env.FORCE_YARN === \"true\" ||\r\n    (execPath != null && path.basename(execPath).startsWith(\"yarn\")) ||\r\n    (userAgent != null && /\\byarn\\b/.test(userAgent))\r\n}\r\n\r\nexport interface RebuildOptions {\r\n  frameworkInfo: DesktopFrameworkInfo\r\n  productionDeps?: Lazy<Array<Dependency>>\r\n\r\n  platform?: NodeJS.Platform\r\n  arch?: string\r\n\r\n  buildFromSource?: boolean\r\n\r\n  additionalArgs?: Array<string> | null\r\n}\r\n\r\n/** @internal */\r\nexport async function rebuild(appDir: string, options: RebuildOptions) {\r\n  const nativeDeps = await BluebirdPromise.filter(await options.productionDeps!.value, it => exists(path.join(it.path, \"binding.gyp\")), {concurrency: 8})\r\n  if (nativeDeps.length === 0) {\r\n    log.info(\"no native production dependencies\")\r\n    return\r\n  }\r\n\r\n  const platform = options.platform || process.platform\r\n  const arch = options.arch || process.arch\r\n  const additionalArgs = options.additionalArgs\r\n\r\n  log.info({platform, arch}, \"rebuilding native production dependencies\")\r\n\r\n  let execPath = process.env.npm_execpath || process.env.NPM_CLI_JS\r\n  const isYarn = isRunningYarn(execPath)\r\n  const execArgs: Array<string> = []\r\n  if (execPath == null) {\r\n    execPath = getPackageToolPath()\r\n  }\r\n  else {\r\n    execArgs.push(execPath)\r\n    execPath = process.env.npm_node_execpath || process.env.NODE_EXE || \"node\"\r\n  }\r\n\r\n  const env = getGypEnv(options.frameworkInfo, platform, arch, options.buildFromSource === true)\r\n  if (isYarn) {\r\n    execArgs.push(\"run\", \"install\")\r\n    if (additionalArgs != null) {\r\n      execArgs.push(...additionalArgs)\r\n    }\r\n    await BluebirdPromise.map(nativeDeps, dep => {\r\n      log.info({name: dep.name}, `rebuilding native dependency`)\r\n      return spawn(execPath!, execArgs, {\r\n        cwd: dep.path,\r\n        env,\r\n      })\r\n        .catch(error => {\r\n          if (dep.optional) {\r\n            log.warn({dep: dep.name}, \"cannot build optional native dep\")\r\n          }\r\n          else {\r\n            throw error\r\n          }\r\n        })\r\n    }, {concurrency: process.platform === \"win32\" ? 1 : 2})\r\n  }\r\n  else {\r\n    execArgs.push(\"rebuild\")\r\n    if (additionalArgs != null) {\r\n      execArgs.push(...additionalArgs)\r\n    }\r\n    execArgs.push(...nativeDeps.map(it => `${it.name}@${it.version}`))\r\n    await spawn(execPath, execArgs, {\r\n      cwd: appDir,\r\n      env,\r\n    })\r\n  }\r\n}\r\n"],"sourceRoot":""}
