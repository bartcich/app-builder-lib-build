{"version":3,"sources":["../../src/util/packageMetadata.ts"],"names":[],"mappings":"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","sourcesContent":["import { isEmptyOrSpaces, log, InvalidConfigurationError } from \"builder-util\"\r\nimport { readFile, readJson } from \"fs-extra-p\"\r\nimport * as path from \"path\"\r\nimport * as semver from \"semver\"\r\nimport { Metadata } from \"..\"\r\n\r\nconst normalizeData = require(\"normalize-package-data\")\r\n\r\n/** @internal */\r\nexport async function readPackageJson(file: string): Promise<any> {\r\n  const data = await readJson(file)\r\n  await authors(file, data)\r\n  normalizeData(data)\r\n  // remove not required fields because can be used for remote build\r\n  delete data.scripts\r\n  delete data.readme\r\n  return data\r\n}\r\n\r\nasync function authors(file: string, data: any) {\r\n  if (data.contributors != null) {\r\n    return\r\n  }\r\n\r\n  let authorData\r\n  try {\r\n    authorData = await readFile(path.resolve(path.dirname(file), \"AUTHORS\"), \"utf8\")\r\n  }\r\n  catch (ignored) {\r\n    return\r\n  }\r\n\r\n  data.contributors = authorData\r\n    .split(/\\r?\\n/g)\r\n    .map(it => it.replace(/^\\s*#.*$/, \"\").trim())\r\n}\r\n\r\n/** @internal */\r\nexport function checkMetadata(metadata: Metadata, devMetadata: any | null, appPackageFile: string, devAppPackageFile: string): void {\r\n  const errors: Array<string> = []\r\n  const reportError = (missedFieldName: string) => {\r\n    errors.push(`Please specify '${missedFieldName}' in the package.json (${appPackageFile})`)\r\n  }\r\n\r\n  const checkNotEmpty = (name: string, value: string | null | undefined) => {\r\n    if (isEmptyOrSpaces(value)) {\r\n      reportError(name)\r\n    }\r\n  }\r\n\r\n  if ((metadata as any).directories != null) {\r\n    errors.push(`\"directories\" in the root is deprecated, please specify in the \"build\"`)\r\n  }\r\n\r\n  checkNotEmpty(\"name\", metadata.name)\r\n\r\n  if (isEmptyOrSpaces(metadata.description)) {\r\n    log.warn({appPackageFile}, `description is missed in the package.json`)\r\n  }\r\n  if (metadata.author == null) {\r\n    log.warn({appPackageFile}, `author is missed in the package.json`)\r\n  }\r\n  checkNotEmpty(\"version\", metadata.version)\r\n\r\n  if (metadata != null) {\r\n    checkDependencies(metadata.dependencies, errors)\r\n  }\r\n  if (metadata !== devMetadata) {\r\n    if (metadata.build != null) {\r\n      errors.push(`'build' in the application package.json (${appPackageFile}) is not supported since 3.0 anymore. Please move 'build' into the development package.json (${devAppPackageFile})`)\r\n    }\r\n  }\r\n\r\n  const devDependencies = (metadata as any).devDependencies\r\n  if (devDependencies != null && \"electron-rebuild\" in devDependencies) {\r\n    log.info('electron-rebuild not required if you use electron-builder, please consider to remove excess dependency from devDependencies\\n\\nTo ensure your native dependencies are always matched electron version, simply add script `\"postinstall\": \"electron-builder install-app-deps\" to your `package.json`')\r\n  }\r\n\r\n  if (errors.length > 0) {\r\n    throw new InvalidConfigurationError(errors.join(\"\\n\"))\r\n  }\r\n}\r\n\r\nfunction versionSatisfies(version: string | semver.SemVer | null, range: string | semver.Range, loose?: boolean): boolean {\r\n  if (version == null) {\r\n    return false\r\n  }\r\n\r\n  const coerced = semver.coerce(version)\r\n  if (coerced == null) {\r\n    return false\r\n  }\r\n\r\n  return semver.satisfies(coerced, range, loose)\r\n}\r\n\r\nfunction checkDependencies(dependencies: { [key: string]: string } | null | undefined, errors: Array<string>) {\r\n  if (dependencies == null) {\r\n    return\r\n  }\r\n\r\n  const updaterVersion = dependencies[\"electron-updater\"]\r\n  const requiredElectronUpdaterVersion = \"4.0.0\"\r\n  if (updaterVersion != null && !versionSatisfies(updaterVersion, `>=${requiredElectronUpdaterVersion}`)) {\r\n    errors.push(`At least electron-updater ${requiredElectronUpdaterVersion} is recommended by current electron-builder version. Please set electron-updater version to \"^${requiredElectronUpdaterVersion}\"`)\r\n  }\r\n\r\n  const swVersion = dependencies[\"electron-builder-squirrel-windows\"]\r\n  if (swVersion != null && !versionSatisfies(swVersion, \">=20.32.0\")) {\r\n    errors.push(`At least electron-builder-squirrel-windows 20.32.0 is required by current electron-builder version. Please set electron-builder-squirrel-windows to \"^20.32.0\"`)\r\n  }\r\n\r\n  const deps = [\"electron\", \"electron-prebuilt\", \"electron-rebuild\"]\r\n  if (process.env.ALLOW_ELECTRON_BUILDER_AS_PRODUCTION_DEPENDENCY !== \"true\") {\r\n    deps.push(\"electron-builder\")\r\n  }\r\n  for (const name of deps) {\r\n    if (name in dependencies) {\r\n      errors.push(`Package \"${name}\" is only allowed in \"devDependencies\". `\r\n        + `Please remove it from the \"dependencies\" section in your package.json.`)\r\n    }\r\n  }\r\n}"],"sourceRoot":""}
