{"version":3,"sources":["../../src/util/packageDependencies.ts"],"names":[],"mappings":";;;;;;;;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;;;;;;AAuBA;AACA,MAAM,yBAAyB,GAAG,IAAI,GAAJ,CAAQ,CACxC,gCADwC,EACN,mBADM,EACe,gBADf,EAExC,gBAFwC,EAEtB,mBAFsB,EAED,oBAFC,EAGxC,kBAHwC,EAGpB,KAHoB,EAIxC,kBAJwC,EAIpB,qBAJoB,EAIG,sBAJH,EAKxC,QALwC,CAAR,CAAlC,C,CAQA;;AACM,SAAU,wBAAV,CAAmC,UAAnC,EAAqD;AACzD,SAAO,KAAI,eAAJ,EAAS,MAAM,yBAAyB,CAAC,UAAD,CAAxC,CAAP;AACD;AAED;;;AACO,eAAe,yBAAf,CAAyC,MAAzC,EAAuD;AAC5D,QAAM,MAAM,GAAsB,EAAlC;AACA,EAAA,kBAAkB,EAAC,MAAM,IAAI,SAAJ,GAAgB,OAAhB,CAAwB,MAAxB,CAAP,GAAwC,MAAxC,EAAgD,KAAhD,CAAlB;AACA,SAAO,MAAP;AACD;;AAED,MAAM,iBAAiB,GAAG,IAAI,GAAJ,CAAQ,CAAC,aAAD,EAAgB,QAAhB,EAA0B,MAA1B,EAAkC,SAAlC,EAA6C,YAA7C,EAA2D,OAA3D,EAAoE,MAApE,EAA4E,SAA5E,EAAuF,UAAvF,EAAmG,SAAnG,EAA8G,aAA9G,EAA6H,cAA7H,EAA6I,UAA7I,EAAyJ,iBAAzJ,EAA4K,OAA5K,EAAqL,SAArL,EAAgM,OAAhM,EAAyM,IAAzM,EAA+M,aAA/M,CAAR,CAA1B;;AAEA,SAAS,QAAT,CAAkB,IAAlB,EAA8B;AAC5B,SAAO,0BAAS,IAAT,EAAe,OAAf,EACJ,IADI,CACC,EAAE,IAAI,IAAI,CAAC,KAAL,CAAW,EAAX,EAAe,CAAC,GAAD,EAAM,KAAN,KAAgB,iBAAiB,CAAC,GAAlB,CAAsB,GAAtB,IAA6B,SAA7B,GAAyC,KAAxE,CADP,CAAP;AAED;;AAED,SAAS,kBAAT,CAA4B,MAA5B,EAAgD,MAAhD,EAA2E,YAA3E,EAAgG;AAC9F,QAAM,YAAY,GAAG,MAAM,CAAC,YAA5B;;AACA,MAAI,YAAY,IAAI,IAApB,EAA0B;AACxB;AACD;;AAED,OAAK,MAAM,GAAX,IAAkB,YAAY,CAAC,MAAb,EAAlB,EAAyC;AACvC,QAAI,GAAG,CAAC,UAAJ,KAAmB,YAAvB,EAAqC;AACnC,MAAA,MAAM,CAAC,IAAP,CAAY,GAAZ;AACA,MAAA,kBAAkB,CAAC,GAAD,EAAM,MAAN,EAAc,YAAd,CAAlB;AACD;AACF;AACF;;AAED,MAAM,SAAN,CAAe;AAAf,EAAA,WAAA,GAAA;AACW,SAAA,cAAA,GAAiB,IAAI,GAAJ,EAAjB;AACD,SAAA,UAAA,GAAa,IAAI,GAAJ,EAAb;AAwOT;;AAtOC,QAAM,OAAN,CAAc,GAAd,EAAyB;AACvB,UAAM,cAAc,GAAe,MAAM,QAAQ,CAAC,IAAI,CAAC,IAAL,CAAU,GAAV,EAAe,cAAf,CAAD,CAAjD;AACA,UAAM,KAAK,aAAL,CAAmB,IAAI,CAAC,IAAL,CAAU,GAAV,EAAe,cAAf,CAAnB,EAAmD,cAAnD,EAAmE,cAAc,CAAC,IAAlF,CAAN;AACA,SAAK,gBAAL,CAAsB,cAAtB;;AAEA,QAAI,KAAK,UAAL,CAAgB,IAAhB,GAAuB,CAA3B,EAA8B;AAC5B,yBAAI,KAAJ,CAAU;AAAC,QAAA,UAAU,EAAE,KAAK,CAAC,IAAN,CAAW,KAAK,UAAL,CAAgB,IAAhB,EAAX,EAAmC,IAAnC,CAAwC,IAAxC;AAAb,OAAV,EAAuE,2CAAvE;;AACA,YAAM,KAAK,wBAAL,CAA8B,cAA9B,EAA8C,GAA9C,CAAN;AACD;;AACD,WAAO,cAAP;AACD;;AAEO,QAAM,wBAAN,CAA+B,cAA/B,EAA2D,GAA3D,EAAsE;AAC5E,QAAI,cAAc,GAAG,cAAc,CAAC,YAApC;;AACA,QAAI,cAAc,IAAI,IAAtB,EAA4B;AAC1B,MAAA,cAAc,CAAC,YAAf,GAA8B,IAAI,GAAJ,EAA9B;AACA,MAAA,cAAc,GAAG,cAAc,CAAC,YAAhC;AACD;;AAED,QAAI,SAAS,GAAG,GAAhB;;AACA,OAAG;AACD,MAAA,SAAS,GAAG,IAAI,CAAC,OAAL,CAAa,SAAb,CAAZ;;AACA,UAAI,SAAS,KAAK,EAAd,IAAoB,SAAS,CAAC,QAAV,CAAmB,GAAnB,CAApB,IAA+C,SAAS,CAAC,QAAV,CAAmB,IAAnB,CAAnD,EAA6E;AAC3E;AACA,cAAM,IAAI,GAAG,KAAK,CAAC,IAAN,CAAW,KAAK,UAAL,CAAgB,IAAhB,EAAX,EAAmC,MAAnC,CAA0C,EAAE,IAAI,CAAC,KAAK,UAAL,CAAgB,GAAhB,CAAoB,EAApB,CAAjD,CAAb;;AACA,YAAI,IAAI,CAAC,MAAL,KAAgB,CAAhB,IAAqB,IAAI,CAAC,CAAD,CAAJ,KAAY,eAArC,EAAsD;AACpD;AACA,UAAA,SAAS,GAAG,OAAO,CAAC,GAAR,EAAZ;AACD,SAHD,MAIK;AACH,cAAI,IAAI,CAAC,MAAL,KAAgB,CAApB,EAAuB;AACrB,kBAAM,OAAO,GAAG,4BAA4B,IAAI,CAAC,IAAL,CAAU,IAAV,CAAe,EAA3D;;AACA,gBAAI,8BAAU,OAAO,CAAC,GAAR,CAAY,8CAAtB,CAAJ,EAA2E;AACzE,iCAAI,IAAJ,CAAS,OAAT;AACD,aAFD,MAGK;AACH,oBAAM,IAAI,KAAJ,CAAU,OAAV,CAAN;AACD;AACF;;AACD;AACD;AACF;;AAED,YAAM,oBAAoB,GAAG,SAAS,GAAG,IAAI,CAAC,GAAjB,GAAuB,cAApD;AACA,YAAM,OAAO,GAAG,MAAM,sBAAW,oBAAX,CAAtB;;AACA,UAAI,OAAO,IAAI,IAAX,IAAmB,CAAC,OAAO,CAAC,WAAR,EAAxB,EAA+C;AAC7C,YAAI,OAAO,IAAI,IAAX,IAAmB,CAAC,OAAO,CAAC,WAAR,EAAxB,EAA+C;AAC7C;AACD;AACF,OA7BA,CA+BD;AACA;AACA;;;AACA,aAAO,IAAP,EAAa;AACX,cAAM,UAAU,GAAG,KAAK,CAAC,IAAN,CAAW,KAAK,UAAL,CAAgB,IAAhB,EAAX,CAAnB;AACA,aAAK,UAAL,CAAgB,KAAhB;AAEA,cAAM,QAAQ,GAAG,MAAM,uBAAgB,GAAhB,CAAoB,UAApB,EAAgC,EAAE,IAAG;AAC1D,iBAAO,KAAK,gBAAL,CAAsB,EAAtB,EAA0B,oBAA1B,EAAgD,cAAhD,EACJ,KADI,CACE,CAAC,IAAG;AACT,gBAAK,CAA2B,CAAC,IAA5B,KAAqC,QAA1C,EAAoD;AAClD,qBAAO,IAAP;AACD,aAFD,MAGK;AACH,oBAAM,CAAN;AACD;AACF,WARI,CAAP;AASD,SAVsB,EAUpB,iBAVoB,CAAvB;AAYA,YAAI,WAAW,GAAG,KAAlB;;AAEA,aAAK,MAAM,GAAX,IAAkB,QAAlB,EAA4B;AAC1B,cAAI,GAAG,IAAI,IAAX,EAAiB;AACf,YAAA,WAAW,GAAG,IAAd;AACA,iBAAK,gBAAL,CAAsB,GAAtB;AACA,YAAA,cAAc,CAAC,GAAf,CAAmB,GAAG,CAAC,QAAvB,EAAiC,GAAjC;AACD;AACF;;AAED,YAAI,CAAC,WAAL,EAAkB;AAChB;AACD;;AAED,aAAK,gBAAL,CAAsB,cAAtB;;AAEA,YAAI,KAAK,UAAL,CAAgB,IAAhB,KAAyB,CAA7B,EAAgC;AAC9B;AACD;AACF;AACF,KAtED,QAuEO,KAAK,UAAL,CAAgB,IAAhB,GAAuB,CAvE9B;AAwED;;AAEO,QAAM,aAAN,CAAoB,cAApB,EAA4C,UAA5C,EAAoE,IAApE,EAAgF;AACtF,IAAA,UAAU,CAAC,QAAX,GAAsB,IAAtB;AACA,IAAA,UAAU,CAAC,qBAAX,GAAmC,UAAU,CAAC,YAAX,IAA2B,IAA3B,GAAkC,IAAlC,GAAyC,MAAM,CAAC,IAAP,CAAY,UAAU,CAAC,YAAvB,CAA5E,CAFsF,CAItF;AACA;;AACA,IAAA,UAAU,CAAC,UAAX,GAAwB,IAAxB;AACA,IAAA,UAAU,CAAC,QAAX,GAAsB,IAAtB;;AAEA,QAAI,UAAU,CAAC,YAAX,IAA2B,IAA3B,IAAmC,UAAU,CAAC,oBAAX,IAAmC,IAA1E,EAAgF;AAC9E;AACA,MAAA,UAAU,CAAC,YAAX,GAA0B,IAA1B;AACA;AACD;;AAED,UAAM,YAAY,GAAG,MAAM,kBAAkB,CAAC,cAAD,CAA7C;;AACA,QAAI,YAAY,IAAI,IAApB,EAA0B;AACxB,MAAA,UAAU,CAAC,YAAX,GAA0B,IAA1B;AACA;AACD;;AAED,UAAM,IAAI,GAAG,MAAM,uBAAgB,GAAhB,CAAoB,YAApB,EAAkC,EAAE,IAAI,KAAK,gBAAL,CAAsB,EAAtB,EAA0B,cAA1B,EAA0C,UAA1C,CAAxC,EAA+F,iBAA/F,CAAnB;;AACA,QAAI,IAAI,CAAC,MAAL,KAAgB,CAApB,EAAuB;AACrB,MAAA,UAAU,CAAC,YAAX,GAA0B,IAA1B;AACA;AACD;;AAED,UAAM,cAAc,GAAG,IAAI,GAAJ,EAAvB;;AACA,SAAK,MAAM,GAAX,IAAkB,IAAlB,EAAwB;AACtB,UAAI,GAAG,IAAI,IAAX,EAAiB;AACf,QAAA,cAAc,CAAC,GAAf,CAAmB,GAAG,CAAC,QAAvB,EAAiC,GAAjC;AACD;AACF;;AACD,IAAA,UAAU,CAAC,YAAX,GAA0B,cAA1B;AACD;;AAEO,QAAM,gBAAN,CAAuB,IAAvB,EAAqC,cAArC,EAA6D,MAA7D,EAA+E;AACrF,UAAM,MAAM,GAAG,IAAI,CAAC,IAAL,CAAU,cAAV,EAA0B,IAA1B,CAAf;AACA,QAAI,GAAG,GAAkB,MAAzB;AACA,UAAM,IAAI,GAAG,MAAM,uBAAM,GAAN,CAAnB;AACA,UAAM,cAAc,GAAG,IAAI,CAAC,cAAL,EAAvB;;AACA,QAAI,cAAJ,EAAoB;AAClB,MAAA,GAAG,GAAG,MAAM,qCAAqB,0BAAS,GAAT,CAArB,CAAZ;;AACA,UAAI,GAAG,IAAI,IAAX,EAAiB;AACf,2BAAI,KAAJ,CAAU;AAAC,UAAA,IAAI,EAAE;AAAP,SAAV,EAA0B,gBAA1B;;AACA,eAAO,IAAP;AACD;AACF;;AAED,UAAM,SAAS,GAAG,KAAK,cAAL,CAAoB,GAApB,CAAwB,GAAxB,CAAlB;;AACA,QAAI,SAAS,IAAI,IAAjB,EAAuB;AACrB,aAAO,SAAP;AACD;;AAED,UAAM,QAAQ,GAAe,MAAM,qCAAqB,QAAQ,CAAC,IAAI,CAAC,IAAL,CAAU,GAAV,EAAe,cAAf,CAAD,CAA7B,CAAnC;;AACA,QAAI,QAAQ,IAAI,IAAhB,EAAsB;AACpB,aAAO,IAAP;AACD;;AAED,QAAI,cAAJ,EAAoB;AAClB,MAAA,QAAQ,CAAC,IAAT,GAAgB,GAAhB;AACA,MAAA,QAAQ,CAAC,IAAT,GAAgB,IAAhB;AACD,KAHD,MAIK;AACH,MAAA,QAAQ,CAAC,MAAT,GAAkB,MAAlB,CADG,CAGH;;AACA,MAAA,QAAQ,CAAC,IAAT,GAAgB,SAAhB;AACD;;AAED,IAAA,QAAQ,CAAC,IAAT,GAAgB,MAAhB,CAlCqF,CAoCrF;;AACA,SAAK,cAAL,CAAoB,GAApB,CAAwB,GAAxB,EAA6B,QAA7B;AAEA,UAAM,KAAK,aAAL,CAAmB,GAAG,GAAG,IAAI,CAAC,GAAX,GAAiB,cAApC,EAAoD,QAApD,EAA8D,IAA9D,CAAN;AACA,WAAO,QAAP;AACD;;AAEO,EAAA,MAAM,CAAC,IAAD,EAAyB,GAAzB,EAA0C,aAA1C,EAAkE,UAAlE,EAAqF;AACjG,SAAK,MAAM,IAAX,IAAmB,IAAnB,EAAyB;AACvB,YAAM,GAAG,GAAG,KAAK,OAAL,CAAa,GAAb,EAAkB,IAAlB,EAAwB,UAAxB,CAAZ;;AACA,UAAI,GAAG,IAAI,IAAX,EAAiB;AACf,YAAI,aAAJ,EAAmB;AACjB,UAAA,GAAG,CAAC,QAAJ,GAAe,KAAf;AACD;;AACD,YAAI,GAAG,CAAC,UAAR,EAAoB;AAClB,eAAK,gBAAL,CAAsB,GAAtB;AACD;AACF;AACF;AACF;;AAEO,EAAA,gBAAgB,CAAC,GAAD,EAAgB;AACtC;AACA;AACA;AAEA,IAAA,GAAG,CAAC,UAAJ,GAAiB,KAAjB;;AAEA,QAAI,GAAG,CAAC,qBAAJ,IAA6B,IAAjC,EAAuC;AACrC,WAAK,MAAL,CAAY,GAAG,CAAC,qBAAhB,EAAuC,GAAvC,EAA4C,IAA5C,EAAkD,KAAlD;AACD;;AAED,QAAI,GAAG,CAAC,gBAAJ,IAAwB,IAA5B,EAAkC;AAChC,WAAK,MAAL,CAAY,MAAM,CAAC,IAAP,CAAY,GAAG,CAAC,gBAAhB,CAAZ,EAA+C,GAA/C,EAAoD,IAApD,EAA0D,KAA1D;AACD;;AAED,QAAI,GAAG,CAAC,oBAAJ,IAA4B,IAAhC,EAAsC;AACpC,WAAK,MAAL,CAAY,MAAM,CAAC,IAAP,CAAY,GAAG,CAAC,oBAAhB,CAAZ,EAAmD,GAAnD,EAAwD,KAAxD,EAA+D,IAA/D;AACD;AACF,GAjNY,CAmNb;;;AACQ,EAAA,OAAO,CAAC,GAAD,EAAkB,IAAlB,EAAgC,UAAhC,EAAmD;AAChE,QAAI,YAAY,CAAC,IAAD,CAAhB,EAAwB;AACtB,aAAO,IAAP;AACD;;AAED,QAAI,CAAC,GAAkC,GAAvC;AACA,QAAI,KAAK,GAAG,IAAZ;;AACA,WAAO,CAAC,IAAI,IAAL,IAAa,KAAK,IAAI,IAA7B,EAAmC;AACjC;AACA;AACA,MAAA,KAAK,GAAG,CAAC,CAAC,YAAF,IAAkB,IAAlB,GAAyB,IAAzB,GAAgC,CAAC,CAAC,YAAF,CAAe,GAAf,CAAmB,IAAnB,CAAxC;;AACA,UAAI,KAAK,IAAI,IAAT,IAAiB,CAAC,CAAC,QAAF,KAAe,IAApC,EAA0C;AACxC,QAAA,KAAK,GAAG,CAAR;AACD;;AACD,MAAA,CAAC,GAAG,CAAC,CAAC,IAAF,IAAU,IAAV,GAAiB,CAAC,CAAC,MAAnB,GAA4B,IAAhC;AACD;;AAED,QAAI,KAAK,IAAI,IAAb,EAAmB;AACjB,WAAK,UAAL,CAAgB,GAAhB,CAAoB,IAApB,EAA0B,UAA1B;AACD;;AACD,WAAO,KAAP;AACD;;AAzOY;;AA4Of,SAAS,YAAT,CAAsB,IAAtB,EAAkC;AAChC,SAAO,yBAAyB,CAAC,GAA1B,CAA8B,IAA9B,KAAuC,IAAI,CAAC,UAAL,CAAgB,SAAhB,CAA9C;AACD;;AAED,eAAe,kBAAf,CAAkC,GAAlC,EAA6C;AAC3C,MAAI,KAAJ;;AACA,MAAI;AACF,IAAA,KAAK,GAAG,CAAC,MAAM,yBAAQ,GAAR,CAAP,EAAqB,MAArB,CAA4B,EAAE,IAAI,CAAC,EAAE,CAAC,UAAH,CAAc,GAAd,CAAD,IAAuB,CAAC,yBAAyB,CAAC,GAA1B,CAA8B,EAA9B,CAA1D,CAAR;AACD,GAFD,CAGA,OAAO,CAAP,EAAU;AACR;AACA,WAAO,IAAP;AACD;;AAED,EAAA,KAAK,CAAC,IAAN;AAEA,QAAM,MAAM,GAAG,KAAK,CAAC,MAAN,CAAa,EAAE,IAAI,EAAE,CAAC,UAAH,CAAc,GAAd,CAAnB,CAAf;;AACA,MAAI,MAAM,CAAC,MAAP,KAAkB,CAAtB,EAAyB;AACvB,WAAO,KAAP;AACD;;AAED,QAAM,MAAM,GAAG,KAAK,CAAC,MAAN,CAAa,EAAE,IAAI,CAAC,EAAE,CAAC,UAAH,CAAc,GAAd,CAApB,CAAf;AACA,QAAM,aAAa,GAAG,MAAM,uBAAgB,GAAhB,CAAoB,MAApB,EAA4B,EAAE,IAAI,yBAAQ,IAAI,CAAC,IAAL,CAAU,GAAV,EAAe,EAAf,CAAR,CAAlC,CAA5B;;AACA,OAAK,IAAI,CAAC,GAAG,CAAb,EAAgB,CAAC,GAAG,MAAM,CAAC,MAA3B,EAAmC,CAAC,EAApC,EAAwC;AACtC,UAAM,IAAI,GAAG,aAAa,CAAC,CAAD,CAA1B;AACA,IAAA,IAAI,CAAC,IAAL;;AACA,SAAK,MAAM,IAAX,IAAmB,IAAnB,EAAyB;AACvB,UAAI,CAAC,IAAI,CAAC,UAAL,CAAgB,GAAhB,CAAL,EAA2B;AACzB,QAAA,MAAM,CAAC,IAAP,CAAY,GAAG,MAAM,CAAC,CAAD,CAAG,IAAI,IAAI,EAAhC;AACD;AACF;AACF;;AAED,SAAO,MAAP;AACD,C","sourcesContent":["import BluebirdPromise from \"bluebird-lst\"\r\nimport { isEnvTrue, log } from \"builder-util\"\r\nimport { CONCURRENCY, statOrNull } from \"builder-util/out/fs\"\r\nimport { orNullIfFileNotExist } from \"builder-util/out/promise\"\r\nimport { lstat, readdir, readFile, realpath, Stats } from \"fs-extra-p\"\r\nimport { Lazy } from \"lazy-val\"\r\nimport * as path from \"path\"\r\n\r\nexport interface Dependency {\r\n  name: string\r\n  version: string\r\n  path: string\r\n  extraneous: boolean\r\n  optional: boolean\r\n\r\n  dependencies: Map<string, Dependency> | null\r\n  directDependencyNames: Array<string> | null\r\n  peerDependencies: { [key: string]: any } | null\r\n  optionalDependencies: { [key: string]: any } | null\r\n\r\n  realName: string\r\n  link?: string\r\n\r\n  parent?: Dependency\r\n\r\n  // only if link\r\n  stat?: Stats\r\n}\r\n\r\n// noinspection SpellCheckingInspection\r\nconst knownAlwaysIgnoredDevDeps = new Set([\r\n  \"electron-builder-tslint-config\", \"electron-download\", \"libui-download\",\r\n  \"electron-forge\", \"electron-packager\", \"electron-compilers\",\r\n  \"prebuild-install\", \"nan\",\r\n  \"electron-webpack\", \"electron-webpack-ts\", \"electron-webpack-vue\",\r\n  \"@types\",\r\n])\r\n\r\n// noinspection JSUnusedGlobalSymbols\r\nexport function createLazyProductionDeps(projectDir: string) {\r\n  return new Lazy(() => getProductionDependencies(projectDir))\r\n}\r\n\r\n/** @internal */\r\nexport async function getProductionDependencies(folder: string): Promise<Array<Dependency>> {\r\n  const result: Array<Dependency> = []\r\n  computeSortedPaths(await new Collector().collect(folder), result, false)\r\n  return result\r\n}\r\n\r\nconst ignoredProperties = new Set([\"description\", \"author\", \"bugs\", \"engines\", \"repository\", \"build\", \"main\", \"license\", \"homepage\", \"scripts\", \"maintainers\", \"contributors\", \"keywords\", \"devDependencies\", \"files\", \"typings\", \"types\", \"xo\", \"resolutions\"])\r\n\r\nfunction readJson(file: string) {\r\n  return readFile(file, \"utf-8\")\r\n    .then(it => JSON.parse(it, (key, value) => ignoredProperties.has(key) ? undefined : value))\r\n}\r\n\r\nfunction computeSortedPaths(parent: Dependency, result: Array<Dependency>, isExtraneous: boolean) {\r\n  const dependencies = parent.dependencies\r\n  if (dependencies == null) {\r\n    return\r\n  }\r\n\r\n  for (const dep of dependencies.values()) {\r\n    if (dep.extraneous === isExtraneous) {\r\n      result.push(dep)\r\n      computeSortedPaths(dep, result, isExtraneous)\r\n    }\r\n  }\r\n}\r\n\r\nclass Collector {\r\n  readonly pathToMetadata = new Map<string, Dependency>()\r\n  private unresolved = new Map<string, boolean>()\r\n\r\n  async collect(dir: string) {\r\n    const rootDependency: Dependency = await readJson(path.join(dir, \"package.json\"))\r\n    await this.readInstalled(path.join(dir, \"node_modules\"), rootDependency, rootDependency.name)\r\n    this.unmarkExtraneous(rootDependency)\r\n\r\n    if (this.unresolved.size > 0) {\r\n      log.debug({unresolved: Array.from(this.unresolved.keys()).join(\", \")}, \"unresolved dependencies after first round\")\r\n      await this.resolveUnresolvedHoisted(rootDependency, dir)\r\n    }\r\n    return rootDependency\r\n  }\r\n\r\n  private async resolveUnresolvedHoisted(rootDependency: Dependency, dir: string): Promise<void> {\r\n    let nameToMetadata = rootDependency.dependencies\r\n    if (nameToMetadata == null) {\r\n      rootDependency.dependencies = new Map<string, Dependency>()\r\n      nameToMetadata = rootDependency.dependencies\r\n    }\r\n\r\n    let parentDir = dir\r\n    do {\r\n      parentDir = path.dirname(parentDir)\r\n      if (parentDir === \"\" || parentDir.endsWith(\"/\") || parentDir.endsWith(\"\\\\\")) {\r\n        // https://github.com/electron-userland/electron-builder/issues/2220\r\n        const list = Array.from(this.unresolved.keys()).filter(it => !this.unresolved.get(it))\r\n        if (list.length === 1 && list[0] === \"proton-native\") {\r\n          // resolve in tests\r\n          parentDir = process.cwd()\r\n        }\r\n        else {\r\n          if (list.length !== 0) {\r\n            const message = `Unresolved node modules: ${list.join(\", \")}`\r\n            if (isEnvTrue(process.env.ELECTRON_BUILDER_ALLOW_UNRESOLVED_DEPENDENCIES)) {\r\n              log.warn(message)\r\n            }\r\n            else {\r\n              throw new Error(message)\r\n            }\r\n          }\r\n          break\r\n        }\r\n      }\r\n\r\n      const parentNodeModulesDir = parentDir + path.sep + \"node_modules\"\r\n      const dirStat = await statOrNull(parentNodeModulesDir)\r\n      if (dirStat == null || !dirStat.isDirectory()) {\r\n        if (dirStat == null || !dirStat.isDirectory()) {\r\n          continue\r\n        }\r\n      }\r\n\r\n      // https://github.com/electron-userland/electron-builder/issues/2222#issuecomment-339060335\r\n      // step 1: resolve current unresolved\r\n      // step n: try to resolve new unresolved in the same parent dir until at least something is resolved in the dir\r\n      while (true) {\r\n        const unresolved = Array.from(this.unresolved.keys())\r\n        this.unresolved.clear()\r\n\r\n        const resolved = await BluebirdPromise.map(unresolved, it => {\r\n          return this.readChildPackage(it, parentNodeModulesDir, rootDependency)\r\n            .catch(e => {\r\n              if ((e as NodeJS.ErrnoException).code === \"ENOENT\") {\r\n                return null\r\n              }\r\n              else {\r\n                throw e\r\n              }\r\n            })\r\n        }, CONCURRENCY)\r\n\r\n        let hasResolved = false\r\n\r\n        for (const dep of resolved) {\r\n          if (dep != null) {\r\n            hasResolved = true\r\n            this.unmarkExtraneous(dep)\r\n            nameToMetadata.set(dep.realName, dep)\r\n          }\r\n        }\r\n\r\n        if (!hasResolved) {\r\n          break\r\n        }\r\n\r\n        this.unmarkExtraneous(rootDependency)\r\n\r\n        if (this.unresolved.size === 0) {\r\n          return\r\n        }\r\n      }\r\n    }\r\n    while (this.unresolved.size > 0)\r\n  }\r\n\r\n  private async readInstalled(nodeModulesDir: string, dependency: Dependency, name: string): Promise<void> {\r\n    dependency.realName = name\r\n    dependency.directDependencyNames = dependency.dependencies == null ? null : Object.keys(dependency.dependencies)\r\n\r\n    // mark as extraneous at this point.\r\n    // this will be un-marked in unmarkExtraneous, where we mark as not-extraneous everything that is required in some way from the root object.\r\n    dependency.extraneous = true\r\n    dependency.optional = true\r\n\r\n    if (dependency.dependencies == null && dependency.optionalDependencies == null) {\r\n      // package has only dev or peer dependencies - no need to check child node_module\r\n      dependency.dependencies = null\r\n      return\r\n    }\r\n\r\n    const childModules = await readNodeModulesDir(nodeModulesDir)\r\n    if (childModules == null) {\r\n      dependency.dependencies = null\r\n      return\r\n    }\r\n\r\n    const deps = await BluebirdPromise.map(childModules, it => this.readChildPackage(it, nodeModulesDir, dependency), CONCURRENCY)\r\n    if (deps.length === 0) {\r\n      dependency.dependencies = null\r\n      return\r\n    }\r\n\r\n    const nameToMetadata = new Map<string, Dependency>()\r\n    for (const dep of deps) {\r\n      if (dep != null) {\r\n        nameToMetadata.set(dep.realName, dep)\r\n      }\r\n    }\r\n    dependency.dependencies = nameToMetadata\r\n  }\r\n\r\n  private async readChildPackage(name: string, nodeModulesDir: string, parent: Dependency): Promise<Dependency | null> {\r\n    const rawDir = path.join(nodeModulesDir, name)\r\n    let dir: string | null = rawDir\r\n    const stat = await lstat(dir)\r\n    const isSymbolicLink = stat.isSymbolicLink()\r\n    if (isSymbolicLink) {\r\n      dir = await orNullIfFileNotExist(realpath(dir))\r\n      if (dir == null) {\r\n        log.debug({path: rawDir}, \"broken symlink\")\r\n        return null\r\n      }\r\n    }\r\n\r\n    const processed = this.pathToMetadata.get(dir)\r\n    if (processed != null) {\r\n      return processed\r\n    }\r\n\r\n    const metadata: Dependency = await orNullIfFileNotExist(readJson(path.join(dir, \"package.json\")))\r\n    if (metadata == null) {\r\n      return null\r\n    }\r\n\r\n    if (isSymbolicLink) {\r\n      metadata.link = dir\r\n      metadata.stat = stat\r\n    }\r\n    else {\r\n      metadata.parent = parent\r\n\r\n      // overwrite if already set by project package.json\r\n      metadata.link = undefined\r\n    }\r\n\r\n    metadata.path = rawDir\r\n\r\n    // do not add root project to result\r\n    this.pathToMetadata.set(dir, metadata)\r\n\r\n    await this.readInstalled(dir + path.sep + \"node_modules\", metadata, name)\r\n    return metadata\r\n  }\r\n\r\n  private unmark(deps: Iterable<string>, obj: Dependency, unsetOptional: boolean, isOptional: boolean) {\r\n    for (const name of deps) {\r\n      const dep = this.findDep(obj, name, isOptional)\r\n      if (dep != null) {\r\n        if (unsetOptional) {\r\n          dep.optional = false\r\n        }\r\n        if (dep.extraneous) {\r\n          this.unmarkExtraneous(dep)\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  private unmarkExtraneous(obj: Dependency) {\r\n    // Mark all non-required deps as extraneous.\r\n    // start from the root object and mark as non-extraneous all modules\r\n    // that haven't been previously flagged as extraneous then propagate to all their dependencies\r\n\r\n    obj.extraneous = false\r\n\r\n    if (obj.directDependencyNames != null) {\r\n      this.unmark(obj.directDependencyNames, obj, true, false)\r\n    }\r\n\r\n    if (obj.peerDependencies != null) {\r\n      this.unmark(Object.keys(obj.peerDependencies), obj, true, false)\r\n    }\r\n\r\n    if (obj.optionalDependencies != null) {\r\n      this.unmark(Object.keys(obj.optionalDependencies), obj, false, true)\r\n    }\r\n  }\r\n\r\n  // find the one that will actually be loaded by require() so we can make sure it's valid\r\n  private findDep(obj: Dependency, name: string, isOptional: boolean) {\r\n    if (isIgnoredDep(name)) {\r\n      return null\r\n    }\r\n\r\n    let r: Dependency | null | undefined = obj\r\n    let found = null\r\n    while (r != null && found == null) {\r\n      // if r is a valid choice, then use that.\r\n      // kinda weird if a pkg depends on itself, but after the first iteration of this loop, it indicates a dep cycle.\r\n      found = r.dependencies == null ? null : r.dependencies.get(name)\r\n      if (found == null && r.realName === name) {\r\n        found = r\r\n      }\r\n      r = r.link == null ? r.parent : null\r\n    }\r\n\r\n    if (found == null) {\r\n      this.unresolved.set(name, isOptional)\r\n    }\r\n    return found\r\n  }\r\n}\r\n\r\nfunction isIgnoredDep(name: string) {\r\n  return knownAlwaysIgnoredDevDeps.has(name) || name.startsWith(\"@types/\")\r\n}\r\n\r\nasync function readNodeModulesDir(dir: string): Promise<Array<string> | null> {\r\n  let files: Array<string>\r\n  try {\r\n    files = (await readdir(dir)).filter(it => !it.startsWith(\".\") && !knownAlwaysIgnoredDevDeps.has(it))\r\n  }\r\n  catch (e) {\r\n    // error indicates that nothing is installed here\r\n    return null\r\n  }\r\n\r\n  files.sort()\r\n\r\n  const scopes = files.filter(it => it.startsWith(\"@\"))\r\n  if (scopes.length === 0) {\r\n    return files\r\n  }\r\n\r\n  const result = files.filter(it => !it.startsWith(\"@\"))\r\n  const scopeFileList = await BluebirdPromise.map(scopes, it => readdir(path.join(dir, it)))\r\n  for (let i = 0; i < scopes.length; i++) {\r\n    const list = scopeFileList[i]\r\n    list.sort()\r\n    for (const file of list) {\r\n      if (!file.startsWith(\".\")) {\r\n        result.push(`${scopes[i]}/${file}`)\r\n      }\r\n    }\r\n  }\r\n\r\n  return result\r\n}\r\n"],"sourceRoot":""}
