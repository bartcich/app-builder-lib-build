{"version":3,"sources":["../../src/util/repositoryInfo.ts"],"names":[],"mappings":"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","sourcesContent":["import { orNullIfFileNotExist } from \"builder-util/out/promise\"\r\nimport { readFile } from \"fs-extra-p\"\r\nimport { fromUrl, Info } from \"hosted-git-info\"\r\nimport * as path from \"path\"\r\nimport { SourceRepositoryInfo } from \"../core\"\r\nimport { Metadata, RepositoryInfo } from \"..\"\r\n\r\nexport function getRepositoryInfo(projectDir: string, metadata?: Metadata, devMetadata?: Metadata | null): Promise<SourceRepositoryInfo | null> {\r\n  return _getInfo(projectDir, (devMetadata == null ? null : devMetadata.repository) || (metadata == null ? null : metadata.repository))\r\n}\r\n\r\nasync function getGitUrlFromGitConfig(projectDir: string): Promise<string | null> {\r\n  const data = await orNullIfFileNotExist(readFile(path.join(projectDir, \".git\", \"config\"), \"utf8\"))\r\n  if (data == null) {\r\n    return null\r\n  }\r\n\r\n  const conf = data.split(/\\r?\\n/)\r\n  const i = conf.indexOf('[remote \"origin\"]')\r\n  if (i !== -1) {\r\n    let u = conf[i + 1]\r\n    if (!u.match(/^\\s*url =/)) {\r\n      u = conf[i + 2]\r\n    }\r\n\r\n    if (u.match(/^\\s*url =/)) {\r\n      return u.replace(/^\\s*url = /, \"\")\r\n    }\r\n  }\r\n  return null\r\n}\r\n\r\nasync function _getInfo(projectDir: string, repo?: RepositoryInfo | string | null): Promise<SourceRepositoryInfo | null> {\r\n  if (repo != null) {\r\n    return parseRepositoryUrl(typeof repo === \"string\" ? repo : repo.url)\r\n  }\r\n\r\n  const slug = process.env.TRAVIS_REPO_SLUG || process.env.APPVEYOR_REPO_NAME\r\n  if (slug != null) {\r\n    const splitted = slug.split(\"/\")\r\n    return {\r\n      user: splitted[0],\r\n      project: splitted[1],\r\n    }\r\n  }\r\n\r\n  const user = process.env.CIRCLE_PROJECT_USERNAME\r\n  const project = process.env.CIRCLE_PROJECT_REPONAME\r\n  if (user != null && project != null) {\r\n    return {\r\n      user,\r\n      project,\r\n    }\r\n  }\r\n\r\n  const url = await getGitUrlFromGitConfig(projectDir)\r\n  return url == null ? null : parseRepositoryUrl(url)\r\n}\r\n\r\nfunction parseRepositoryUrl(url: string): Info {\r\n  const info: any = fromUrl(url)\r\n  if (info != null) {\r\n    delete info.protocols\r\n    delete info.treepath\r\n    delete info.filetemplate\r\n    delete info.bugstemplate\r\n    delete info.gittemplate\r\n    delete info.tarballtemplate\r\n    delete info.sshtemplate\r\n    delete info.sshurltemplate\r\n    delete info.browsetemplate\r\n    delete info.docstemplate\r\n    delete info.httpstemplate\r\n    delete info.shortcuttemplate\r\n    delete info.pathtemplate\r\n    delete info.pathmatch\r\n    delete info.protocols_re\r\n    delete info.committish\r\n    delete info.default\r\n    delete info.opts\r\n    delete info.browsefiletemplate\r\n    delete info.auth\r\n  }\r\n  return info\r\n}"],"sourceRoot":""}
