{"version":3,"sources":["../../src/util/AppFileWalker.ts"],"names":[],"mappings":"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","sourcesContent":["import { Filter, FileConsumer } from \"builder-util/out/fs\"\r\nimport { readlink, stat, Stats } from \"fs-extra-p\"\r\nimport { FileMatcher } from \"../fileMatcher\"\r\nimport { Packager } from \"../packager\"\r\nimport * as path from \"path\"\r\n\r\nconst nodeModulesSystemDependentSuffix = `${path.sep}node_modules`\r\n\r\nfunction addAllPatternIfNeed(matcher: FileMatcher) {\r\n  if (!matcher.isSpecifiedAsEmptyArray && (matcher.isEmpty() || matcher.containsOnlyIgnore())) {\r\n    matcher.prependPattern(\"**/*\")\r\n  }\r\n  return matcher\r\n}\r\n\r\nexport abstract class FileCopyHelper {\r\n  readonly metadata = new Map<string, Stats>()\r\n\r\n  protected constructor(protected readonly matcher: FileMatcher, readonly filter: Filter | null, protected readonly packager: Packager) {\r\n  }\r\n\r\n  protected handleFile(file: string, parent: string, fileStat: Stats): Promise<Stats | null> | null {\r\n    if (!fileStat.isSymbolicLink()) {\r\n      return null\r\n    }\r\n\r\n    return readlink(file)\r\n      .then((linkTarget): any => {\r\n        // http://unix.stackexchange.com/questions/105637/is-symlinks-target-relative-to-the-destinations-parent-directory-and-if-so-wh\r\n        return this.handleSymlink(fileStat, file, parent, linkTarget)\r\n      })\r\n  }\r\n\r\n  private handleSymlink(fileStat: Stats, file: string, parent: string, linkTarget: string): Promise<Stats> | null {\r\n    const resolvedLinkTarget = path.resolve(parent, linkTarget)\r\n    const link = path.relative(this.matcher.from, resolvedLinkTarget)\r\n    if (link.startsWith(\"..\")) {\r\n      // outside of project, linked module (https://github.com/electron-userland/electron-builder/issues/675)\r\n      return stat(resolvedLinkTarget)\r\n        .then(targetFileStat => {\r\n          this.metadata.set(file, targetFileStat)\r\n          return targetFileStat\r\n        })\r\n    }\r\n    else {\r\n      const s = (fileStat as any)\r\n      s.relativeLink = link\r\n      s.linkRelativeToFile = path.relative(parent, resolvedLinkTarget)\r\n    }\r\n    return null\r\n  }\r\n}\r\n\r\nfunction createAppFilter(matcher: FileMatcher, packager: Packager): Filter | null {\r\n  if (packager.areNodeModulesHandledExternally) {\r\n    return matcher.isEmpty() ? null : matcher.createFilter()\r\n  }\r\n\r\n  const nodeModulesFilter: Filter = (file, fileStat) => {\r\n    return !(fileStat.isDirectory() && file.endsWith(nodeModulesSystemDependentSuffix))\r\n  }\r\n\r\n  if (matcher.isEmpty()) {\r\n    return nodeModulesFilter\r\n  }\r\n\r\n  const filter = matcher.createFilter()\r\n  return (file, fileStat) => {\r\n    if (!nodeModulesFilter(file, fileStat)) {\r\n      return false\r\n    }\r\n    return filter(file, fileStat)\r\n  }\r\n}\r\n\r\n/** @internal */\r\nexport class AppFileWalker extends FileCopyHelper implements FileConsumer {\r\n  constructor(matcher: FileMatcher, packager: Packager) {\r\n    super(addAllPatternIfNeed(matcher), createAppFilter(matcher, packager), packager)\r\n  }\r\n\r\n  // noinspection JSUnusedGlobalSymbols\r\n  consume(file: string, fileStat: Stats, parent: string, siblingNames: Array<string>): any {\r\n    if (fileStat.isDirectory()) {\r\n      // https://github.com/electron-userland/electron-builder/issues/1539\r\n      // but do not filter if we inside node_modules dir\r\n      // update: solution disabled, node module resolver should support such setup\r\n      if (file.endsWith(nodeModulesSystemDependentSuffix)) {\r\n        return false\r\n      }\r\n    }\r\n    else {\r\n      // save memory - no need to store stat for directory\r\n      this.metadata.set(file, fileStat)\r\n    }\r\n\r\n    return this.handleFile(file, parent, fileStat)\r\n  }\r\n}"],"sourceRoot":""}
